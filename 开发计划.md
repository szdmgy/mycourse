# mycourse 优化升级 — 开发计划

> 版本：v1.0  
> 日期：2026-02-22  
> 原则：**边改边测，保留现有功能，逐步优化**

---

## 总体策略

1. **渐进式重构**：不推倒重来，在现有代码基础上逐步改进
2. **每个阶段可测试**：每完成一个阶段，系统仍可正常运行和测试
3. **先后端后前端**：先改数据模型和视图逻辑，再改页面样式
4. **先核心后边缘**：先保证课程/作业/提交核心流程，再处理导入/复用等辅助功能

---

## 阶段划分

### 阶段 0：准备工作

**目标**：建立开发基础环境（Git、venv、启动脚本），确保可测试

| 序号 | 任务 | 说明 |
|------|------|------|
| 0.1 | 初始化 Git 仓库 | `git init`，创建 `.gitignore`（排除 venv/、db.sqlite3、__pycache__/、.idea/、file/、*.pyc、.env） |
| 0.2 | 创建项目内虚拟环境 | 在 Django 项目根目录下创建 `venv/`，安装依赖 |
| 0.3 | 生成 `requirements.txt` | 记录 Django、openpyxl、waitress 等依赖及版本 |
| 0.4 | 创建 `run_local.bat` | 一键测试启动脚本（端口 9900），按全局规则要求：激活 venv、设环境变量、清理残留进程、输出访问 URL |
| 0.5 | 优化 `start_server.bat` | 生产部署脚本保留 Waitress 方式，路径改为项目内 `venv/`（不再硬编码 `D:\mycourse\newvenv`） |
| 0.6 | 备份当前数据库 | 复制 `db.sqlite3` 为 `db.sqlite3.bak` |
| 0.7 | 下载 Bootstrap Icons 离线资源 | 下载 `bootstrap-icons.min.css` + 字体文件到 `static/` |
| 0.8 | 验证现有功能可用 | 用 run_local.bat 启动，确认登录/课程/作业/提交全流程正常 |
| 0.9 | 首次 Git commit | 提交初始代码 |

**测试点**：
- `run_local.bat` 双击可启动，端口 9900，控制台输出访问 URL
- `start_server.bat` 用项目内 venv 正常启动 Waitress
- 现有功能不受影响

---

### 阶段 1：数据模型升级

**目标**：完成模型变更和数据库重建

| 序号 | 任务 | 涉及文件 |
|------|------|----------|
| 1.1 | Task 模型新增 `maxFiles`、`slot1Name`、`slot2Name`、`slot3Name` | `models.py` |
| 1.2 | Homework 模型移除 `filePath` 字段 | `models.py` |
| 1.3 | 新增 `HomeworkFile` 模型 | `models.py` |
| 1.4 | `filePath` 相关字段 max_length 改为 255 | `models.py` |
| 1.5 | 删除旧的 migration 文件和 db.sqlite3 | `migrations/` |
| 1.6 | 重新生成 migration 并 migrate | 命令行 |
| 1.7 | createsuperuser 重建管理员 | 命令行 |
| 1.8 | 更新 `admin.py` 注册新模型 | `admin.py` |

**测试点**：
- `python manage.py check` 无报错
- `python manage.py runserver 9900` 正常启动
- admin 后台可登录，可看到新模型
- 创建测试数据验证模型关系

---

### 阶段 2：核心 Bug 修复 + 代码清理

**目标**：修复已知 Bug，清理代码，不改变页面外观

| 序号 | 任务 | 涉及文件 |
|------|------|----------|
| 2.1 | 提取公共 `file_iterator()` 为工具函数 | 新建 `app01/utils.py` |
| 2.2 | 修复 `filePath.split('\\')` 为 `os.path.basename()` | `views.py` 多处 |
| 2.3 | 修复 `removeStudentByTeacher-btn` 硬编码路由 | `teacherTasks.js` |
| 2.4 | 修复 `addHomework` 课程查找逻辑（改用 courseID） | `views.py` |
| 2.5 | 修复 `addHomework` 标题查重范围（限当前课程） | `views.py` |
| 2.6 | 修复临时 ZIP 并发问题（改用 tempfile） | `views.py` |
| 2.7 | 替换 `print()` 为 `logging` | `views.py`、`upload_data.py` |
| 2.8 | 给缺少 `@login_required` 的视图加上装饰器 | `views.py` |

**测试点**：
- 所有现有功能仍正常运行
- 教师添加作业不再出错
- 移除学生功能正常
- 教师下载作业（单人/多人）正常

---

### 阶段 3：后端功能新增

**目标**：实现多附件上传/下载、教师添加实验改进

| 序号 | 任务 | 涉及文件 |
|------|------|----------|
| 3.1 | 改造 `post_file` 视图支持多附件（含 slot 参数） | `views.py` |
| 3.2 | 改造 `download_file` 视图支持多附件 | `views.py` |
| 3.3 | 改造教师批量下载支持多附件 ZIP 打包 | `views.py` |
| 3.4 | 改造 `addHomework` 视图：增加 deadline、maxFiles、slot 名称 | `views.py` |
| 3.5 | 改造 `taskChange` 视图：支持编辑附件槽配置 | `views.py` |
| 3.6 | 新增 `copyTasks` 视图：复用历史实验 | `views.py` |
| 3.7 | 新增 `getHistoryTasks` API：获取可复用的历史实验列表 | `views.py` |
| 3.8 | 更新 `urls.py` 添加新路由 | `urls.py` |
| 3.9 | 改造 `homeworkRecords` 和 `delayRecords` 适配新模型 | `views.py` |
| 3.10 | 改造 `studentCourse` 适配新模型（提交状态） | `views.py` |

**测试点**：
- 通过 admin 后台创建测试课程和作业
- 用 Postman 或浏览器测试上传/下载 API
- 验证多附件存储路径正确
- 验证历史实验复用接口返回数据正确

---

### 阶段 4：导入预览确认流程

**目标**：重构数据导入，实现解析→预览→确认→写入

| 序号 | 任务 | 涉及文件 |
|------|------|----------|
| 4.1 | 重构 `upload_data.py`：拆分为解析函数和写入函数 | `upload_data.py` |
| 4.2 | 新增 `preview_import` 视图：解析文件并返回预览数据 | `views.py` |
| 4.3 | 新增 `confirm_import` 视图：确认后执行写入 | `views.py` |
| 4.4 | 预览数据存 session（或临时文件）供确认时使用 | `views.py` |
| 4.5 | 新增 `import_preview.html` 模板：预览结果页面 | `templates/` |
| 4.6 | 更新路由 | `urls.py` |

**测试点**：
- 上传 Excel 后显示预览结果（不写库）
- 预览中正确标注新建/已存在/冲突
- 点击确认后数据正确写入
- 点击取消后数据库无变化
- 上传格式错误的文件有明确错误提示

---

### 阶段 5：UI 重构 — 基础框架

**目标**：统一 Bootstrap 5，建立公共模板，设定全局大字体

| 序号 | 任务 | 涉及文件 |
|------|------|----------|
| 5.1 | 创建 `base.html` 公共模板（导航栏+页面框架+全局字体） | `templates/base.html` |
| 5.2 | 在 base.html 中设定全局字体规范 | body 20px，表格 18px，h1 32px/h2 28px/h3 24px |
| 5.3 | 创建 `static/css/global.css` 全局样式 | 字体、间距、按钮等统一规范 |
| 5.4 | 移除 Bootstrap 3 相关 CSS/JS 文件 | `static/css/`、`static/js/` |
| 5.5 | 确认 Bootstrap 5 离线资源完整 | `static/` |
| 5.6 | 确认 Bootstrap Icons 离线资源就位 | `static/css/`、`static/fonts/` |
| 5.7 | `login.html` 保持独立（不继承 base），同步大字体样式 | `templates/` |
| 5.8 | `change_password.html` 改为继承 base.html | `templates/` |
| 5.9 | `profile.html` 改为继承 base.html | `templates/` |

**测试点**：
- 登录页正常显示，字体清晰偏大
- 登录后页面有统一的顶部导航
- 导航栏根据角色正确显示/隐藏菜单项
- 全站字体大小符合规范（正文 20px，标题相应放大）
- 页面样式统一、无 Bootstrap 3/5 冲突

---

### 阶段 6：UI 重构 — 学生端页面

**目标**：学生端页面适配新功能

| 序号 | 任务 | 涉及文件 |
|------|------|----------|
| 6.1 | `studentCourseList.html` 继承 base.html | `templates/` |
| 6.2 | `studentTaskList.html` 继承 base.html + 提交状态可视化 | `templates/` |
| 6.3 | `studentSubmit.html` 重构：支持多附件槽位上传 | `templates/` |
| 6.4 | 更新上传 JS 逻辑支持多 slot | `templates/` 或 `static/js/` |

**测试点**：
- 学生登录 → 课程列表 → 作业列表（带状态图标）→ 提交页面
- 作业有 1 个附件：显示 1 个上传区域
- 作业有 3 个附件：显示 3 个上传区域，各有名称
- 上传/替换/下载每个附件正常
- 状态图标正确（已交/未交/逾期）

---

### 阶段 7：UI 重构 — 教师端页面

**目标**：教师端课程详情 Tab 布局

| 序号 | 任务 | 涉及文件 |
|------|------|----------|
| 7.1 | `teacherCourseList.html` 继承 base.html | `templates/` |
| 7.2 | 新建 `teacherCourseDetail.html` Tab 布局 | `templates/` |
| 7.3 | Tab 1 - 作业管理（列表+添加+编辑+删除+复用） | `templates/` |
| 7.4 | Tab 2 - 提交统计（已交/未交+批量下载） | `templates/` |
| 7.5 | Tab 3 - 学生管理（名单+添加+移除+重置密码） | `templates/` |
| 7.6 | Tab 4 - 课程设置（信息修改+异常记录+删除） | `templates/` |
| 7.7 | 更新 `teacherTasks.js` 适配新页面 | `static/js/` |
| 7.8 | 历史实验复用 - 前端弹窗和交互 | `templates/` + `static/js/` |
| 7.9 | `homeworkRecords.html` 继承 base.html | `templates/` |
| 7.10 | `delayRecords.html` 继承 base.html | `templates/` |
| 7.11 | `taskChange.html` 继承 base.html + 支持附件槽配置 | `templates/` |

**测试点**：
- 教师课程详情 Tab 切换正常
- Tab 1：添加实验（含截止日期+附件槽）成功
- Tab 1：从历史复用成功
- Tab 2：提交统计数据正确，批量下载正常
- Tab 3：添加/移除学生正常
- Tab 4：修改课程/删除课程正常

---

### 阶段 8：UI 重构 — 管理员页面 + 导入预览

**目标**：管理员页面适配 + 导入预览前端

| 序号 | 任务 | 涉及文件 |
|------|------|----------|
| 8.1 | `manager.html` 继承 base.html | `templates/` |
| 8.2 | `userList.html` 继承 base.html | `templates/` |
| 8.3 | `upload_files.html` 重构：增加预览确认步骤 | `templates/` |
| 8.4 | `import_preview.html` 新增：预览结果展示+确认按钮 | `templates/` |

**测试点**：
- 管理员控制台功能完整
- 上传 Excel → 显示预览 → 确认写入全流程
- 上传错误文件有明确错误提示
- 用你提供的"单片机原理与应用1班.xlsx"样表测试通过

---

### 阶段 9：收尾与清理

**目标**：清理废弃文件，完善细节

| 序号 | 任务 |
|------|------|
| 9.1 | 移除废弃模板（login2.html、teacher.html、test.html、副本文件等） |
| 9.2 | 移除 Bootstrap 3 CSS/JS 文件 |
| 9.3 | 移除旧版学生/教师页面（被新页面替代的） |
| 9.4 | 清理 urls.py 中的废弃路由 |
| 9.5 | 全面功能回归测试 |
| 9.6 | 更新 `start_server.bat` 和 `run_local.bat` |
| 9.7 | 编写简要使用说明 |

**测试点**：全流程回归测试
- 管理员：登录 → 导入课程 → 添加实验 → 查看提交 → 下载作业 → 用户管理
- 教师：登录 → 查看课程 → 管理实验 → 复用历史 → 查看统计 → 下载作业
- 学生：登录 → 改密 → 查看课程 → 查看作业 → 提交附件 → 下载已交文件

---

## 实施时间线（预估）

| 阶段 | 内容 | 预估工作量 |
|------|------|-----------|
| 阶段 0 | 准备工作 | 较小 |
| 阶段 1 | 数据模型升级 | 较小 |
| 阶段 2 | Bug 修复 + 代码清理 | 中等 |
| 阶段 3 | 后端功能新增 | 较大 |
| 阶段 4 | 导入预览确认 | 中等 |
| 阶段 5 | UI 基础框架 | 中等 |
| 阶段 6 | 学生端页面 | 中等 |
| 阶段 7 | 教师端页面 | 较大 |
| 阶段 8 | 管理员页面 + 导入预览前端 | 中等 |
| 阶段 9 | 收尾清理 | 较小 |

---

## 风险与应对

| 风险 | 应对 |
|------|------|
| Bootstrap 5 迁移可能导致样式错乱 | 逐页面迁移，每页完成后测试 |
| 多附件改造影响面大 | 先完成后端+数据库，再逐步改前端 |
| 导入预览 session 数据量可能大 | 改用临时文件存储，有效期内自动清理 |
| 前端离线资源缺失 | 在阶段 0 统一检查并补全 |

---

## 沟通与版本控制约定

- 每个阶段开始前简要说明本阶段目标
- 每个阶段完成后请你测试确认再进入下一阶段
- **每个阶段测试通过后做一次 Git commit**，commit message 标注阶段编号和内容
- 遇到方案不合理或有更好做法时及时沟通
- 需要新的设计决策时先讨论确认

---

*文档状态：待确认。确认后开始阶段 0 实施。*
