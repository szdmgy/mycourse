# mycourse 学生实验报告收集系统 — 需求文档

> 版本：v2.0（优化版）  
> 日期：2026-02-22  
> 状态：待确认

---

## 一、产品概述

### 1.1 产品定位

面向高校实验教学的**作业/实验报告在线收集系统**，部署于局域网环境，供教师布置实验、学生提交报告、管理员统一管理。

### 1.2 部署环境约束

| 约束 | 说明 |
|------|------|
| 网络 | **纯局域网**，不可访问外网 |
| 前端资源 | 所有 CSS/JS/字体等必须**本地离线文件**，禁止 CDN |
| 数据库 | SQLite（单机部署，并发量低） |
| 服务器 | Waitress（Windows），开发测试用 Django runserver |
| Python | 3.10+，项目内 venv 隔离 |

### 1.3 技术栈

| 层面 | 技术 | 版本 |
|------|------|------|
| 后端 | Django | 5.2.x |
| 数据库 | SQLite3 | — |
| 前端框架 | Bootstrap 5.1.3 | 离线文件 |
| JS 库 | jQuery 3.x、SheetJS | 离线文件 |
| Excel 解析 | openpyxl | — |

---

## 二、角色与权限

### 2.1 角色定义

| 角色 | 标识 | 说明 |
|------|------|------|
| **管理员** | `is_superuser=True` | 系统最高权限，承担大部分管理工作 |
| **教师** | `type='T'` | 管理自己的课程与实验 |
| **学生** | `type='S'` | 查看实验、提交作业 |

### 2.2 权限矩阵

| 功能 | 管理员 | 教师 | 学生 |
|------|--------|------|------|
| Django Admin 后台 | ✅ | ❌ | ❌ |
| 查看所有课程 | ✅ | ❌（仅自己的） | ❌（仅自己的） |
| 创建/编辑/删除课程 | ✅（任意课程） | ✅（仅自己的） | ❌ |
| 添加/编辑/删除实验 | ✅（任意课程） | ✅（仅自己的课程） | ❌ |
| 复用历史实验 | ✅（可看所有人的） | ✅（仅自己的） | ❌ |
| 添加/移除学生 | ✅ | ✅（仅自己的课程） | ❌ |
| 导入课程 Excel | ✅ | ✅ | ❌ |
| 查看提交记录 | ✅ | ✅（仅自己的课程） | ❌ |
| 批量下载作业 | ✅ | ✅（仅自己的课程） | ❌ |
| 重置学生密码 | ✅ | ✅（自己课程内的学生） | ❌ |
| 用户管理（增删用户） | ✅ | ❌ | ❌ |
| 提交作业 | ❌ | ❌ | ✅ |
| 下载自己提交的文件 | ❌ | ❌ | ✅ |
| 修改个人信息/密码 | ✅ | ✅ | ✅ |

**核心原则**：管理员权限 ≥ 教师权限，管理员能做教师能做的一切，且能跨课程操作。

---

## 三、数据模型

### 3.1 模型关系图

```
User (Django内置)
  └── 1:1 ── UserProfile
                ├── name, gender, type(T/S), email, phone
                │
Course ────────── members (M2M) ── UserProfile
  ├── courseTerm, courseNumber, courseName
  ├── classNumber, teachers, status
  │
  └── 1:N ── Task
               ├── title, content, display, deadline
               ├── uploadFileType
               ├── maxFiles (1~3)
               ├── slot1Name, slot2Name, slot3Name
               │
               └── 1:N ── Homework
                            ├── user (FK→UserProfile)
                            ├── time
                            │
                            └── 1:N ── HomeworkFile
                                         ├── slot (1/2/3)
                                         ├── filePath
                                         └── originalName
```

### 3.2 模型字段详细定义

#### UserProfile（保留不变）

| 字段 | 类型 | 说明 |
|------|------|------|
| user | OneToOneField(User) | 关联 Django 内置用户 |
| name | CharField(20) | 真实姓名 |
| gender | CharField(2) | M=男, F=女 |
| type | CharField(2) | T=老师, S=学生 |
| email | EmailField | 邮箱 |
| phone | CharField(11) | 手机号 |

#### Course（保留不变）

| 字段 | 类型 | 说明 |
|------|------|------|
| courseTerm | CharField(30) | 学期，如 "2025-2026学年第一学期" |
| courseNumber | CharField(30) | 课程编号 |
| courseName | CharField(30) | 课程名 |
| classNumber | CharField(2) | 班级编号 |
| teachers | CharField(30) | 授课教师（文本） |
| members | ManyToManyField(UserProfile) | 课程成员 |
| status | CharField(10) | Y=开启, N=关闭 |
| **唯一约束** | | (courseTerm, courseNumber, classNumber) |

#### Task（改动）

| 字段 | 类型 | 改动 | 说明 |
|------|------|------|------|
| title | CharField(100) | 保留 | 作业标题 |
| content | TextField | 保留 | 作业正文 |
| display | BooleanField | 保留 | 是否对学生显示 |
| courseBelongTo | ForeignKey(Course) | 保留 | 所属课程 |
| uploadFileType | CharField(30) | 保留 | 允许上传的文件类型 |
| deadline | DateField | 保留 | 截止日期 |
| **maxFiles** | **IntegerField** | **新增** | 最大附件数，1~3，默认1 |
| **slot1Name** | **CharField(50)** | **新增** | 附件槽1名称，必填，如"实验报告" |
| **slot2Name** | **CharField(50)** | **新增** | 附件槽2名称，maxFiles≥2时必填 |
| **slot3Name** | **CharField(50)** | **新增** | 附件槽3名称，maxFiles=3时必填 |
| **唯一约束** | | 保留 | (courseBelongTo, title) |

#### Homework（改动）

| 字段 | 类型 | 改动 | 说明 |
|------|------|------|------|
| user | ForeignKey(UserProfile) | 保留 | 提交者 |
| task | ForeignKey(Task) | 保留 | 对应作业 |
| time | DateTimeField(auto_now) | 保留 | 最近提交时间 |
| ~~filePath~~ | ~~CharField~~ | **移除** | 迁移到 HomeworkFile |

#### HomeworkFile（新增）

| 字段 | 类型 | 说明 |
|------|------|------|
| homework | ForeignKey(Homework) | 所属提交记录 |
| slot | IntegerField | 对应附件槽位 1/2/3 |
| filePath | CharField(255) | 文件在服务器上的存储路径 |
| originalName | CharField(200) | 原始文件名 |
| **唯一约束** | | (homework, slot) |

---

## 四、功能模块详细需求

### 4.1 认证与用户管理（保留现有功能）

| 功能 | 说明 |
|------|------|
| 登录 | 用户名+密码登录，教师跳转课程列表，学生跳转课程列表 |
| 登出 | 注销登录状态 |
| 首次登录强制改密 | 默认密码登录后强制跳转到修改密码页 |
| 修改密码 | Django 内置 PasswordChangeForm |
| 个人资料编辑 | 修改邮箱、手机号，姓名只读 |
| 默认密码策略 | 学生: `szu + 学号后6位`，教师: `szu + 工号` |
| 密码验证器 | **全部禁用**（用户明确要求） |

### 4.2 课程管理

#### 4.2.1 教师端

- 查看自己的课程列表（状态为"开启"的课程）
- 进入课程详情页（Tab 布局，见 4.8 节）
- 修改课程基本信息（课程名、课程号）
- 删除课程（二次确认）
- 添加/移除学生
- 通过 Excel 导入课程（含学生名单，走预览确认流程）

#### 4.2.2 管理员端

- 查看**所有**课程
- 对任意课程执行教师端的所有操作
- 用户管理（增删用户、重置密码）
- 批量导入课程/学生/教师数据
- 访问 Django Admin 后台

### 4.3 实验/作业管理（重点改进）

#### 4.3.1 添加实验（教师+管理员）

入口：在课程详情页的"作业管理"Tab 中操作

表单字段：
| 字段 | 必填 | 说明 |
|------|------|------|
| 作业标题 | ✅ | 课程内唯一 |
| 作业内容 | ✅ | 多行文本 |
| 截止日期 | ✅ | 日期选择器，默认130天后 |
| 文件类型限制 | 否 | 默认 `*`（不限），可输入如 `.doc,.pdf` |
| 最大附件数 | ✅ | 下拉选择 1/2/3，默认1 |
| 附件槽1名称 | ✅ | 始终显示，如"实验报告" |
| 附件槽2名称 | 条件必填 | 附件数≥2时显示并必填，如"源代码" |
| 附件槽3名称 | 条件必填 | 附件数=3时显示并必填 |

**重要变更**：不再需要指定课程ID——课程上下文由页面自动传递（隐藏字段传 courseID）。

#### 4.3.2 编辑实验

- 教师/管理员在课程详情页直接编辑，**不再跳转 Django Admin**
- 可修改：是否显示、截止日期、附件槽配置
- 标题和所属课程不可修改

#### 4.3.3 删除实验

- 二次确认
- 同时删除该实验下的所有提交记录和文件

#### 4.3.4 复用历史实验（新功能）

入口：课程详情页"作业管理"Tab 中的"从历史复用"按钮

流程：
1. 点击"从历史复用"→ 弹出模态框
2. 列出可复用的实验列表：
   - **教师**：仅显示自己参与的**其他课程**（含往届）中的作业
   - **管理员**：显示**所有课程**中的所有作业
3. 支持按学期、课程名筛选
4. 勾选要复用的实验（可多选）
5. 点击"导入到当前课程"
6. 系统将选中的实验复制到当前课程：
   - 复制字段：标题、内容、文件类型、附件数、槽位名称
   - 不复制：截止日期（需重新设置，默认130天后）
   - 标题冲突时自动追加 `(副本)` 后缀
7. 导入后可以进一步编辑修改

### 4.4 作业提交（改进：多附件）

#### 4.4.1 学生提交页面

- 显示作业详情（标题、内容、截止日期、文件类型限制）
- 根据 `task.maxFiles` 动态显示 1~3 个上传区域
- 每个上传区域显示槽位名称（如"实验报告"、"源代码"）
- 每个槽位独立上传，可单独替换
- 上传成功后显示已上传的文件名（可点击下载）

#### 4.4.2 文件存储规则

```
{BASE_DIR}/file/{学期}/{课程名+班号}/{作业标题}/
    {作业标题}_{学号}_{姓名}_slot{N}_{槽位名}.{后缀}
```

示例：
```
file/2025-2026学年第一学期/单片机原理与应用01/实验一/
    实验一_2023222001_黄楷航_slot1_实验报告.docx
    实验一_2023222001_黄楷航_slot2_源代码.zip
```

#### 4.4.3 提交状态可视化（#22 优化）

学生作业列表页中，每个作业用颜色+图标标注状态：

| 状态 | 样式 | 说明 |
|------|------|------|
| ✅ 已提交 | 绿色 badge + 对勾图标 | 截止前已交齐所有必需附件 |
| ⚠️ 部分提交 | 黄色 badge | 附件数 > 1 但未交齐 |
| 🕐 未提交 | 灰色 badge | 还在截止日期内，尚未提交 |
| ⚠️ 逾期提交 | 橙色 badge | 超过截止日期才提交 |
| ❌ 逾期未提交 | 红色 badge | 超过截止日期且未提交 |

### 4.5 作业下载

#### 4.5.1 学生下载

- 学生在提交页面可下载自己已提交的每个附件

#### 4.5.2 教师/管理员批量下载

- 勾选学生 → 下载选中学生的作业
- 单人单附件：直接下载文件
- 多人或多附件：自动打包 ZIP，目录结构：
  ```
  {作业标题}.zip
  └── {学号}_{姓名}/
      ├── slot1_{槽位名}.docx
      └── slot2_{槽位名}.zip
  ```
- **修复并发问题**：使用临时文件，不再覆盖同一个 temp.zip

### 4.6 数据导入（重点改进）

#### 4.6.1 导入预览确认流程（新机制）

**核心变更**：所有数据导入不再直接写入数据库，统一走"解析 → 预览 → 确认 → 写入"流程。

**流程**：

```
上传 Excel 文件
      ↓
后端解析、模拟校验（不写库）
      ↓
返回预览结果页面，显示：
  - 解析出的课程信息
  - 教师列表（标注：新建/已存在）
  - 学生列表（标注：新建/已存在/信息冲突）
  - 如有错误或冲突，标红显示并说明原因
      ↓
用户检查预览结果
  ├── 确认 → 后端执行写入 → 显示导入结果
  └── 取消 → 放弃导入
```

#### 4.6.2 课程导入 Excel 格式

按现有花名册格式（深圳大学学生成绩登记表）：

| 单元格位置 | 内容 |
|-----------|------|
| A3 | 学期（如"2025-2026学年第一学期"） |
| C5 | 课程编号 |
| F5 | 班号 |
| R5 | 课程名 |
| K6 | 教师姓名（多人用逗号分隔） |
| 第10行起 B/C/D 列 | 学号/姓名/性别 |

#### 4.6.3 导入反馈优化（#21）

导入完成后，前端显示结构化结果表格：

| 信息项 | 显示内容 |
|--------|----------|
| 课程 | 课程名+编号+班号，标注"新建"或"已存在(跳过)" |
| 教师 | 每位教师姓名+工号，标注"新建账号/已存在/关联课程" |
| 学生 | 每位学生学号+姓名，标注"新建账号/已存在/关联课程" |
| 错误 | 红色高亮，说明具体原因（如学号格式错误、重复等） |
| 汇总 | 新建学生 X 人，已存在 X 人，新建教师 X 人，错误 X 条 |

### 4.7 教师端页面重构（UI 改进）

#### 4.7.1 公共顶部导航

所有页面共享统一的顶部导航栏（Bootstrap 5 navbar）：

```
┌─────────────────────────────────────────────────────┐
│ 📋 实验报告收集系统  |  课程列表  |  个人信息  |  [管理员入口]  |  姓名 ▼ 注销  │
└─────────────────────────────────────────────────────┘
```

- 左侧：系统名称
- 中部：导航链接（根据角色动态显示）
- 右侧：用户名+角色+注销
- 管理员入口仅 superuser 可见

#### 4.7.2 教师课程详情页 Tab 布局

将现有的一长页拆分为 4 个 Tab：

**Tab 1：作业管理**
- 作业列表表格（序号、标题、附件数、是否显示、截止日期、操作按钮）
- 操作：编辑 / 查看记录 / 删除
- "添加实验"按钮
- "从历史复用"按钮

**Tab 2：提交统计**
- 每个作业的已提交/未提交人数统计
- 点击可展开查看具体名单
- 批量下载入口

**Tab 3：学生管理**
- 课程内学生名单表格
- 添加单个学生表单
- Excel 导入学生（走预览确认流程）
- 移除学生（二次确认）
- 重置密码

**Tab 4：课程设置**
- 课程基本信息显示与修改
- 异常记录（延期/未交）入口
- 删除课程（二次确认，高危操作）

### 4.8 管理员功能

保留并增强现有管理员功能：

| 功能 | 入口 | 说明 |
|------|------|------|
| 管理员控制台 | `/manager/` | 管理功能入口 |
| 用户管理 | 控制台 → 用户列表 | 查看/删除教师和学生 |
| 添加用户 | 控制台 → 添加 | 手动添加教师或学生 |
| 数据导入 | 控制台 → 导入 | 批量导入课程/学生/教师（预览确认流程） |
| Django Admin | `/admin/` | 数据库直接操作 |
| 课程管理 | 同教师端 | 可操作所有课程 |

---

## 五、页面清单

### 5.1 保留页面（优化 UI）

| 页面 | 角色 | 变化 |
|------|------|------|
| `login.html` | 所有 | 保留现有设计 |
| `change_password.html` | 所有 | 继承 base.html |
| `profile.html` | 所有 | 继承 base.html |
| `studentCourseList.html` | 学生 | 继承 base.html，优化样式 |
| `teacherCourseList.html` | 教师/管理员 | 继承 base.html，优化样式 |
| `manager.html` | 管理员 | 继承 base.html |
| `userList.html` | 管理员 | 继承 base.html |

### 5.2 重构页面

| 页面 | 说明 |
|------|------|
| `base.html` | **新增**，公共基础模板（导航+布局） |
| `teacherCourseDetail.html` | **新增**，替代原 teacherCourseChange + teacherTasks，Tab 布局 |
| `studentTaskList.html` | 重构，增加状态可视化 |
| `studentSubmit.html` | 重构，支持多附件槽位上传 |
| `upload_files.html` | 重构，增加预览确认步骤 |
| `homeworkRecords.html` | 优化，继承 base.html |
| `delayRecords.html` | 优化，继承 base.html |

### 5.3 废弃页面（计划移除）

| 页面 | 原因 |
|------|------|
| `login2.html` | 旧版登录页，已废弃 |
| `teacher.html` | 旧版教师页，已废弃 |
| `test.html` | 测试页 |
| `taskChange - 副本.html` | 备份文件 |
| `studentTasks.html` | 旧版学生作业列表，被 studentTaskList.html 替代 |
| `teacherTasks.html` | 被 teacherCourseDetail.html 替代 |
| `teacherCourseChange.html` | 被 teacherCourseDetail.html 替代 |
| `import.html` | 被 upload_files.html 合并 |

---

## 六、前端资源要求

### 6.1 离线资源清单

所有前端资源必须下载到 `static/` 目录，**禁止任何 CDN 引用**。

| 资源 | 版本 | 文件 |
|------|------|------|
| Bootstrap CSS | 5.1.3 | `css/bootstrap5.1.3.min.css`（已有） |
| Bootstrap JS | 5.1.3 | `js/bootstrap5.1.3.bundle.min.js`（已有） |
| jQuery | 3.x | `js/jquery.min.js`（已有） |
| SheetJS | — | `js/xlsx.mini.js`（已有） |
| Bootstrap Icons | 1.x | `css/bootstrap-icons.min.css` + `fonts/`（**需新增**） |

### 6.2 移除资源

| 资源 | 原因 |
|------|------|
| `css/bootstrap.css` / `.min.css` | Bootstrap 3，被 5.1.3 替代 |
| `css/bootstrap-theme.css` / `.min.css` | Bootstrap 3 主题 |
| `js/bootstrap.min.js`（旧版） | Bootstrap 3 JS |
| `js/popper.min.js` | Bootstrap 5 bundle 已包含 |

---

## 七、已知 Bug 修复清单

| # | 问题 | 位置 | 修复方案 |
|---|------|------|----------|
| 1 | `removeStudentByTeacher-btn` 硬编码 `/removeStudentFromCourse/1/2/3/` | `teacherTasks.js:103` | 改用 `removeStudent` 路由，传 courseID + studentNumber |
| 2 | `addHomework` 用 courseNumber+courseName 查找课程，可能匹配错误 | `views.py:465` | 改为传 courseID，用 `Course.objects.get(id=courseID)` |
| 3 | `addHomework` 中作业标题全局查重 | `views.py:462` | 改为当前课程内查重 |
| 4 | `filePath.split('\\')` 硬编码反斜杠 | 多处 | 改为 `os.path.basename()` |
| 5 | `file_iterator()` 重复定义3次 | `views.py` | 提取为公共工具函数 |
| 6 | 临时 ZIP 路径 `./file/temp/temp.zip` 并发冲突 | `views.py:430` | 使用 `tempfile.NamedTemporaryFile` |
| 7 | `filePath` max_length=100 过短 | `models.py` | 改为 255 |
| 8 | `teacherCourseChange.html` 编辑链接指向 `/admin/` | 模板 | 改为教师端编辑页面 |
| 9 | `print()` 调试残留 | 多处 | 替换为 `logging` |

---

## 八、非功能性要求

| 项目 | 要求 |
|------|------|
| 兼容性 | Chrome / Edge 最近2个大版本 |
| 响应式 | 基本适配平板和大屏，手机端不做优先 |
| 性能 | 页面加载 < 3秒（局域网环境） |
| 数据安全 | 局域网内部使用，不做高安全性要求 |
| 编码 | 全部 UTF-8 |
| 时区 | Asia/Shanghai |
| **字体大小** | **全站正文字体不小于 20px（约为普通网页默认 16px 的 1.25~1.5 倍），表格/列表等内容区域字体 18~20px，标题相应放大，确保在投影仪和大屏下也清晰易读** |

### 8.1 字体规范

考虑到用户为教学场景（可能投影展示），全站字体偏大设计：

| 元素 | 字号 | 说明 |
|------|------|------|
| 页面正文 body | 20px | 基准字号 |
| 表格内容 | 18px | 表格内稍小一点保持紧凑 |
| 表单标签 label | 20px | 与正文一致 |
| 表单输入框 input | 18px | |
| 按钮文字 | 18px | |
| 导航栏文字 | 18px | |
| h1 标题 | 32px | |
| h2 标题 | 28px | |
| h3 标题 | 24px | |
| Badge/标签 | 16px | 状态标签可稍小 |

在 `base.html` 中通过全局 CSS 统一设定，各页面继承即可。

---

## 九、开发与部署环境

### 9.1 版本控制（Git）

- 项目须纳入 Git 管理
- `.gitignore` 排除：`venv/`、`db.sqlite3`、`*.pyc`、`__pycache__/`、`.env`、`file/`（学生上传的文件）、`.idea/`
- 不提交敏感信息（密码、SECRET_KEY 等）
- 每完成一个开发阶段做一次有意义的 commit

### 9.2 虚拟环境

- 项目使用项目内 venv 隔离依赖，**禁止全局安装**
- venv 目录：`{项目根}/venv/`
- 维护 `requirements.txt`，包含所有依赖及版本号
- 当前已知依赖：Django、openpyxl、waitress

### 9.3 启动方式

| 场景 | 方式 | 端口 | 脚本 |
|------|------|------|------|
| **本地开发测试** | `run_local.bat`（Django runserver） | 9900 | 项目根目录 |
| **生产部署** | `start_server.bat`（Waitress） | 8001 | 保留现有方式，优化脚本 |

`run_local.bat` 要求（按全局规则）：
- 双击即启动（自动激活 venv、runserver）
- 设置 `PYTHONUNBUFFERED=1` 和 `PYTHONIOENCODING=utf-8`
- 启动前清理残留 Python 进程（端口 9900）
- 启动前输出访问 URL
- 统一测试端口 9900

`start_server.bat` 保留 Waitress 部署方式，路径改为项目内 venv：
```
call venv\Scripts\activate.bat
waitress-serve --host=0.0.0.0 --port=8001 mycourse.wsgi:application
```

---

## 十、数据库迁移策略

由于模型变更较大（Homework 移除 filePath、新增 HomeworkFile、Task 新增字段），采用**重建策略**：

1. 备份现有数据库
2. 记录现有管理员账号和教师账号
3. 删除 `db.sqlite3` 和所有 migration 文件
4. 重新 `makemigrations` + `migrate`
5. `createsuperuser` 重建管理员
6. 通过 Excel 导入重建教师和课程数据

学生提交数据和课程数据不保留（用户已确认）。
