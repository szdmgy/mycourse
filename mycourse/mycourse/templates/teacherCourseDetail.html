{% extends "base.html" %}
{% load static %}
{% block title %}{{ course.courseName }} - 课程管理{% endblock %}
{% block nav_courses %}active{% endblock %}

{% block extra_css %}
<style>
  .nav-tabs .nav-link { font-size: .95rem; }
  .accordion-button { font-size: .9rem; padding: .6rem 1rem; }
  .accordion-body { font-size: .9rem; }
</style>
{% endblock %}

{% block content %}
<nav aria-label="breadcrumb" class="mb-3">
  <ol class="breadcrumb" style="font-size:.85rem;">
    <li class="breadcrumb-item"><a href="{% url 'teacherCourseList' %}">课程列表</a></li>
    <li class="breadcrumb-item active">{{ course.courseName }}（{{ course.classNumber }}班）</li>
  </ol>
</nav>

<div class="card mb-3">
  <div class="card-body py-2">
    <div class="row" style="font-size:.85rem; color:#555;">
      <div class="col-md-3"><strong>学期：</strong>{{ course.courseTerm }}</div>
      <div class="col-md-2"><strong>编号：</strong>{{ course.courseNumber }}</div>
      <div class="col-md-2"><strong>班号：</strong>{{ course.classNumber }}</div>
      <div class="col-md-2"><strong>教师：</strong>{{ course.teachers }}</div>
      <div class="col-md-3"><strong>学生：</strong>{{ student_count }} 人</div>
    </div>
  </div>
</div>

<!-- ════════ Tab 导航 ════════ -->
<ul class="nav nav-tabs mb-3" id="courseTab" role="tablist">
  <li class="nav-item" role="presentation">
    <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-tasks" type="button">
      <i class="bi bi-list-task"></i> 作业管理
    </button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-stats" type="button">
      <i class="bi bi-bar-chart"></i> 提交统计
    </button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-students" type="button">
      <i class="bi bi-people"></i> 学生管理
    </button>
  </li>
</ul>

<!-- ════════ Tab 内容 ════════ -->
<div class="tab-content" id="courseTabContent">

<!-- ═══ Tab 1：作业管理 ═══ -->
<div class="tab-pane fade show active" id="tab-tasks" role="tabpanel">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h3 class="mb-0">作业列表</h3>
    <div>
      <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addTaskModal">
        <i class="bi bi-plus-lg"></i> 添加作业
      </button>
      <button class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#reuseModal" onclick="loadHistoryTasks()">
        <i class="bi bi-arrow-repeat"></i> 从历史复用
      </button>
      <button class="btn btn-outline-success btn-sm" data-bs-toggle="modal" data-bs-target="#importTaskModal">
        <i class="bi bi-file-earmark-arrow-up"></i> 导入作业
      </button>
    </div>
  </div>

  {% if task_data %}
  <div class="table-responsive">
    <table class="table table-hover align-middle">
      <thead class="table-light">
        <tr>
          <th style="width:40px;">#</th>
          <th>标题</th>
          <th>文件类型</th>
          <th>显示</th>
          <th>截止日期</th>
          <th>已交/总人数</th>
          <th style="width:250px;">操作</th>
        </tr>
      </thead>
      <tbody>
        {% for td in task_data %}
        <tr>
          <td>{{ forloop.counter }}</td>
          <td><strong>{{ td.task.title }}</strong></td>
          <td><code>{{ td.task.fileType }}</code></td>
          <td>
            {% if td.task.display %}
              <span class="badge bg-success">显示</span>
            {% else %}
              <span class="badge bg-secondary">隐藏</span>
            {% endif %}
          </td>
          <td>{{ td.task.deadline|date:"Y-m-d" }}</td>
          <td>
            <span class="badge bg-info">{{ td.submitted_count }}/{{ td.submitted_count|add:td.not_submitted_count }}</span>
          </td>
          <td>
            <a href="{% url 'taskChange' td.task.id td.task.title %}" class="btn btn-outline-primary btn-sm" title="编辑">
              <i class="bi bi-pencil"></i>
            </a>
            <a href="{% url 'homeworkRecords' td.task.id td.task.title %}" class="btn btn-outline-info btn-sm" title="作业记录">
              <i class="bi bi-clipboard-data"></i>
            </a>
            <button class="btn btn-outline-danger btn-sm" title="删除"
                    onclick="deleteTask({{ td.task.id }}, '{{ td.task.title|escapejs }}')">
              <i class="bi bi-trash"></i>
            </button>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% else %}
  <div class="card p-4 text-center">
    <p style="color:#666;"><i class="bi bi-info-circle"></i> 本课程暂无作业，点击"添加作业"或"从历史复用"开始</p>
  </div>
  {% endif %}
</div>

<!-- ═══ Tab 2：提交统计 ═══ -->
<div class="tab-pane fade" id="tab-stats" role="tabpanel">
  <h3 class="mb-3">提交统计</h3>

  {% if task_data %}
  <div class="accordion" id="statsAccordion">
    {% for td in task_data %}
    <div class="accordion-item">
      <h2 class="accordion-header">
        <button class="accordion-button collapsed" type="button"
                data-bs-toggle="collapse" data-bs-target="#stats-{{ td.task.id }}">
          <span class="me-3"><strong>{{ td.task.title }}</strong></span>
          <span class="badge bg-success me-1">已交 {{ td.submitted_count }}</span>
          <span class="badge bg-danger">未交 {{ td.not_submitted_count }}</span>
        </button>
      </h2>
      <div id="stats-{{ td.task.id }}" class="accordion-collapse collapse" data-bs-parent="#statsAccordion">
        <div class="accordion-body">

          <div class="d-flex justify-content-between align-items-center mb-2">
            <h5 class="mb-0">已提交（{{ td.submitted_count }}人）</h5>
            <div>
              <button class="btn btn-sm btn-outline-secondary" onclick="selAll({{ td.task.id }})">全选</button>
              <button class="btn btn-sm btn-outline-secondary" onclick="selNone({{ td.task.id }})">全不选</button>
            </div>
          </div>
          {% if td.submitted %}
          <div class="table-responsive">
            <table class="table table-sm table-hover align-middle">
              <thead class="table-light">
                <tr><th>#</th><th>学号</th><th>姓名</th><th>性别</th><th>提交时间</th><th>附件</th><th>状态</th><th>选择</th></tr>

              </thead>
              <tbody>
                {% for rec in td.submitted %}
                <tr {% if rec.delay %}class="table-warning"{% endif %}>
                  <td>{{ forloop.counter }}</td>
                  <td>{{ rec.number }}</td>
                  <td>{{ rec.name }}</td>
                  <td>{% if rec.gender == 'M' %}男{% else %}女{% endif %}</td>
                  <td>{{ rec.time|date:"Y-m-d H:i" }}</td>
                  <td>{% if rec.has_file %}<span class="badge bg-success">已上传</span>{% else %}<span class="badge bg-secondary">无文件</span>{% endif %}</td>
                  <td>{% if rec.delay %}<span class="badge badge-delay">延期</span>{% else %}<span class="badge badge-submitted">正常</span>{% endif %}</td>
                  <td><input type="checkbox" class="form-check-input chk-{{ td.task.id }}" data-number="{{ rec.number }}"></td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          <button class="btn btn-primary btn-sm"
                  onclick="dlHomework('{{ td.task.title|escapejs }}', {{ td.task.id }})">
            <i class="bi bi-download"></i> 下载选中作业
          </button>
          {% else %}
          <p class="text-muted">暂无人提交</p>
          {% endif %}

          <h5 class="mt-3">未提交（{{ td.not_submitted_count }}人）</h5>
          {% if td.not_submitted %}
          <div class="table-responsive">
            <table class="table table-sm table-hover align-middle">
              <thead class="table-light">
                <tr><th>#</th><th>学号</th><th>姓名</th><th>性别</th></tr>
              </thead>
              <tbody>
                {% for stu in td.not_submitted %}
                <tr>
                  <td>{{ forloop.counter }}</td>
                  <td>{{ stu.user.username }}</td>
                  <td>{{ stu.name }}</td>
                  <td>{% if stu.gender == 'M' %}男{% else %}女{% endif %}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          {% else %}
          <p class="text-muted">全部已交</p>
          {% endif %}

        </div>
      </div>
    </div>
    {% endfor %}
  </div>
  {% else %}
  <div class="card p-4 text-center">
    <p style="color:#666;"><i class="bi bi-info-circle"></i> 本课程暂无作业</p>
  </div>
  {% endif %}

  <div class="card mt-3">
    <div class="card-body">
      <a href="{% url 'delayRecords' course.id %}" class="btn btn-outline-warning">
        <i class="bi bi-exclamation-triangle"></i> 查看异常作业记录（延期/未交）
      </a>
    </div>
  </div>
</div>

<!-- ═══ Tab 3：学生管理 ═══ -->
<div class="tab-pane fade" id="tab-students" role="tabpanel">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h3 class="mb-0">学生名单（{{ student_count }}人）</h3>
    <button class="btn btn-primary btn-sm" data-bs-toggle="collapse" data-bs-target="#addStudentForm">
      <i class="bi bi-person-plus"></i> 添加学生
    </button>
  </div>

  <div class="collapse mb-3" id="addStudentForm">
    <div class="card card-body">
      <form action="{% url 'addStudentToCourseByTeacher' %}" method="post">
        {% csrf_token %}
        <input type="hidden" name="courseID" value="{{ course.id }}">
        <div class="row g-2 align-items-end">
          <div class="col-md-3">
            <label class="form-label">学号 <span class="text-danger">*</span></label>
            <input type="text" class="form-control" name="newStudentNumber" required>
          </div>
          <div class="col-md-3">
            <label class="form-label">姓名 <span class="text-danger">*</span></label>
            <input type="text" class="form-control" name="newStudentName" required>
          </div>
          <div class="col-md-2">
            <label class="form-label">性别</label>
            <select class="form-select" name="newStudentGender">
              <option value="M">男</option>
              <option value="F" selected>女</option>
            </select>
          </div>
          <div class="col-md-2">
            <button type="submit" class="btn btn-primary"><i class="bi bi-plus-lg"></i> 添加</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  {% if student_list %}
  <div class="table-responsive">
    <table class="table table-hover align-middle">
      <thead class="table-light">
        <tr>
          <th style="width:40px;">#</th>
          <th>学号</th>
          <th>姓名</th>
          <th>性别</th>
          <th style="width:220px;">操作</th>
        </tr>
      </thead>
      <tbody>
        {% for stu in student_list %}
        <tr>
          <td>{{ forloop.counter }}</td>
          <td>{{ stu.user.username }}</td>
          <td>{{ stu.name }}</td>
          <td>{% if stu.gender == 'M' %}男{% else %}女{% endif %}</td>
          <td>
            <button class="btn btn-outline-warning btn-sm"
                    onclick="resetPwd('{{ stu.user.username }}', '{{ stu.name|escapejs }}')">
              <i class="bi bi-key"></i> 重置密码
            </button>
            <a href="{% url 'removeStudent' course.id stu.user.username %}"
               class="btn btn-outline-danger btn-sm"
               onclick="return confirm('确定要移除学生 {{ stu.name }}（{{ stu.user.username }}）吗？')">
              <i class="bi bi-person-x"></i> 移除
            </a>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% else %}
  <div class="card p-4 text-center">
    <p style="color:#666;"><i class="bi bi-info-circle"></i> 本课程暂无学生</p>
  </div>
  {% endif %}
</div>

</div><!-- /tab-content -->

<!-- ════════ 模态框：添加作业 ════════ -->
<div class="modal fade" id="addTaskModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="bi bi-plus-lg"></i> 添加作业</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <form action="{% url 'addHomework' %}" method="post">
        {% csrf_token %}
        <div class="modal-body">
          <input type="hidden" name="courseID" value="{{ course.id }}">
          <div class="mb-3">
            <label class="form-label">作业标题 <span class="text-danger">*</span></label>
            <input type="text" class="form-control" name="title" required>
          </div>
          <div class="mb-3">
            <label class="form-label">作业正文 <span class="text-danger">*</span></label>
            <textarea class="form-control" name="content" rows="5" required></textarea>
          </div>
          <div class="row g-3 mb-3">
            <div class="col-md-6">
              <label class="form-label">截止日期</label>
              <input type="date" class="form-control" name="deadline" id="addTaskDeadline">
            </div>
            <div class="col-md-6">
              <label class="form-label">允许的文件类型</label>
              <input type="text" class="form-control" name="fileType" value="*" placeholder="如 .docx,.pdf 或 * 不限">
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
          <button type="submit" class="btn btn-primary"><i class="bi bi-check-lg"></i> 添加</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- ════════ 模态框：历史复用 ════════ -->
<div class="modal fade" id="reuseModal" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="reuseModalTitle"><i class="bi bi-arrow-repeat"></i> 从历史「{{ course.courseName }}」复用实验</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <!-- 步骤1：选班级 -->
        <div id="reuse-step-class">
          <p class="text-muted mb-2" style="font-size:.85rem;">请选择要复用的历史班级：</p>
          <div id="historyClassList"></div>
        </div>
        <!-- 步骤2：选实验 -->
        <div id="reuse-step-tasks" style="display:none;">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <span class="text-muted" style="font-size:.85rem;" id="reuseClassInfo"></span>
            <span>
              <a href="javascript:void(0)" class="text-primary me-2" style="font-size:.85rem;" onclick="toggleAllReuse(true)">全选新增</a>
              <a href="javascript:void(0)" class="text-danger" style="font-size:.85rem;" onclick="toggleAllReuse(false)">全不选</a>
            </span>
          </div>
          <div id="historyTaskList"></div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" id="reuseBackBtn" onclick="reuseGoBack()" style="display:none;">
          <i class="bi bi-arrow-left"></i> 返回选班级
        </button>
        <span id="reuseCount" class="me-auto text-muted"></span>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
        <button type="button" class="btn btn-primary" id="reuseSubmitBtn" onclick="submitReuse()" style="display:none;">
          <i class="bi bi-check-lg"></i> 导入到当前课程
        </button>
      </div>
    </div>
  </div>
</div>

<!-- ════════ 模态框：导入作业 ════════ -->
<div class="modal fade" id="importTaskModal" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="bi bi-file-earmark-arrow-up"></i> 导入作业（Excel）</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <!-- 步骤 1：上传 -->
        <div id="import-step-upload">
          <p class="text-muted" style="font-size:.85rem;">
            Excel 格式：标题 | 内容 | 文件类型(可选, * 为不限) | 显示(Y/N, 可选)<br>
            截止日期自动设为导入日 + 120 天。
            <a href="{% url 'download_template' '作业导入模板.xlsx' %}" class="text-decoration-none">
              <i class="bi bi-download"></i> 下载作业导入模板.xlsx
            </a>
          </p>
          <input type="file" id="importTaskFile" class="form-control" accept=".xls,.xlsx,.xlsm">
          <div id="importTaskError" class="text-danger mt-2" style="display:none;"></div>
        </div>
        <!-- 步骤 2：预览 -->
        <div id="import-step-preview" style="display:none;">
          <div class="alert alert-info py-2" id="importPreviewSummary"></div>
          <div class="table-responsive">
            <table class="table table-sm table-hover">
              <thead>
                <tr><th>#</th><th>标题</th><th>内容</th><th>文件类型</th><th>显示</th><th>状态</th></tr>
              </thead>
              <tbody id="importPreviewBody"></tbody>
            </table>
          </div>
        </div>
        <!-- 步骤 3：结果 -->
        <div id="import-step-result" style="display:none;"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
        <button type="button" class="btn btn-primary" id="importPreviewBtn" onclick="doPreviewTaskImport()">
          <i class="bi bi-eye"></i> 预览
        </button>
        <button type="button" class="btn btn-success" id="importConfirmBtn" onclick="doConfirmTaskImport()" style="display:none;">
          <i class="bi bi-check-lg"></i> 确认导入
        </button>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
var CSRF = '{{ csrf_token }}';
var COURSE_ID = {{ course.id }};

/* ── 添加实验：默认截止日期 ── */
(function(){
  var d = new Date(); d.setDate(d.getDate() + 130);
  var el = document.getElementById('addTaskDeadline');
  if (el && !el.value) el.value = d.toISOString().split('T')[0];
})();

/* ── 删除作业 ── */
function deleteTask(id, title){
  if(confirm('确定要删除作业「' + title + '」吗？\n该操作会丢失所有提交记录和文件！'))
    location.href = '/deleteTaskByTeacher/' + id + '/';
}

/* ── 重置密码 ── */
function resetPwd(username, displayName){
  if(!confirm('确定要重置 ' + displayName + '（' + username + '）的密码吗？')) return;
  $.ajax({
    url: '{% url "resetPassword" %}', type: 'POST',
    data: {user: username},
    headers: {'X-CSRFToken': CSRF},
    success: function(r){ alert(r); },
    error: function(){ alert('密码重置失败！'); }
  });
}

/* ── 提交统计：全选/全不选 ── */
function selAll(tid){ document.querySelectorAll('.chk-'+tid).forEach(function(c){c.checked=true;}); }
function selNone(tid){ document.querySelectorAll('.chk-'+tid).forEach(function(c){c.checked=false;}); }

/* ── 下载选中作业 ── */
function dlHomework(title, tid){
  var list = [];
  document.querySelectorAll('.chk-'+tid+':checked').forEach(function(c){ list.push(c.dataset.number); });
  if(!list.length){ alert('请先勾选要下载的学生作业！'); return; }

  var xhr = new XMLHttpRequest();
  xhr.open('POST', '{% url "download_homework_ByTeacher" %}', true);
  xhr.responseType = 'blob';
  xhr.setRequestHeader('X-CSRFToken', CSRF);
  xhr.setRequestHeader('Content-Type', 'application/json');
  xhr.onload = function(){
    if(this.status === 200){
      var disp = this.getResponseHeader('Content-Disposition');
      var fn = decodeURI(escape(disp.substring(20)));
      var a = document.createElement('a');
      a.href = URL.createObjectURL(new Blob([this.response]));
      a.download = fn; a.click();
    }
  };
  xhr.send(JSON.stringify({taskName:title, taskId:tid, studentNumberList:list}));
}

/* ── 历史复用（两步：选班级 → 选实验） ── */
var _histData = [];

function loadHistoryTasks(){
  document.getElementById('reuse-step-class').style.display = '';
  document.getElementById('reuse-step-tasks').style.display = 'none';
  document.getElementById('reuseBackBtn').style.display = 'none';
  document.getElementById('reuseSubmitBtn').style.display = 'none';
  document.getElementById('reuseCount').textContent = '';
  document.getElementById('historyClassList').innerHTML =
    '<div class="text-center py-3"><div class="spinner-border text-primary"></div><p class="mt-2">加载中...</p></div>';

  $.getJSON('/getHistoryTasks/' + COURSE_ID + '/', function(data){
    _histData = data.courses || [];
    renderClassList(_histData);
  }).fail(function(){
    document.getElementById('historyClassList').innerHTML = '<p class="text-danger">加载失败</p>';
  });
}

function renderClassList(courses){
  if(!courses.length){
    document.getElementById('historyClassList').innerHTML =
      '<p class="text-muted text-center">没有同名历史课程可复用</p>';
    return;
  }
  var h = '';
  courses.forEach(function(c, idx){
    h += '<div class="card mb-2" style="cursor:pointer;" onclick="selectHistClass('+idx+')">';
    h += '<div class="card-body py-3 d-flex justify-content-between align-items-center">';
    h += '<span><i class="bi bi-folder2-open me-2"></i><strong>'+c.classNumber+'班</strong> — '+c.courseTerm+'</span>';
    h += '<span class="badge bg-primary">'+c.tasks.length+' 个实验 <i class="bi bi-chevron-right"></i></span>';
    h += '</div></div>';
  });
  document.getElementById('historyClassList').innerHTML = h;
}

function selectHistClass(idx){
  var c = _histData[idx];
  document.getElementById('reuse-step-class').style.display = 'none';
  document.getElementById('reuse-step-tasks').style.display = '';
  document.getElementById('reuseBackBtn').style.display = '';
  document.getElementById('reuseSubmitBtn').style.display = '';
  document.getElementById('reuseClassInfo').textContent =
    '来源：' + c.classNumber + '班 — ' + c.courseTerm;

  var h = '<div class="list-group list-group-flush">';
  c.tasks.forEach(function(t){
    var dup = t.duplicate;
    h += '<label class="list-group-item d-flex align-items-center gap-2 py-1' + (dup ? ' text-muted' : '') + '">';
    if(dup){
      h += '<input type="checkbox" class="form-check-input reuse-chk" value="'+t.id+'" disabled>';
      h += '<span><s>'+t.title+'</s> <span class="badge bg-warning text-dark" style="font-size:.7rem;">已存在</span></span>';
    } else {
      h += '<input type="checkbox" class="form-check-input reuse-chk" value="'+t.id+'" checked onchange="updateReuseCount()">';
      h += '<span>'+t.title + (t.fileType && t.fileType!='*' ? ' <span class="text-muted" style="font-size:.75rem;">('+t.fileType+')</span>' : '') + '</span>';
    }
    h += '</label>';
  });
  h += '</div>';
  document.getElementById('historyTaskList').innerHTML = h;
  updateReuseCount();
}

function reuseGoBack(){
  document.getElementById('reuse-step-class').style.display = '';
  document.getElementById('reuse-step-tasks').style.display = 'none';
  document.getElementById('reuseBackBtn').style.display = 'none';
  document.getElementById('reuseSubmitBtn').style.display = 'none';
  document.getElementById('reuseCount').textContent = '';
}

function toggleAllReuse(checked){
  document.querySelectorAll('.reuse-chk:not(:disabled)').forEach(function(c){ c.checked = checked; });
  updateReuseCount();
}

function updateReuseCount(){
  var n = document.querySelectorAll('.reuse-chk:checked').length;
  document.getElementById('reuseCount').textContent = n ? '已选 ' + n + ' 项' : '';
}

function submitReuse(){
  var ids = [];
  document.querySelectorAll('.reuse-chk:checked').forEach(function(c){ ids.push(parseInt(c.value)); });
  if(!ids.length){ alert('请先勾选要复用的实验！'); return; }
  $.ajax({
    url: '{% url "copyTasks" %}', type: 'POST',
    contentType: 'application/json',
    headers: {'X-CSRFToken': CSRF},
    data: JSON.stringify({courseID: COURSE_ID, taskIDs: ids}),
    success: function(d){
      if(d.success){
        alert('成功导入 ' + d.copied.length + ' 个实验：\n' + d.copied.join('\n'));
        location.reload();
      } else { alert('导入失败'); }
    },
    error: function(){ alert('导入失败！'); }
  });
}

/* ── 导入实验：预览 ── */
function doPreviewTaskImport(){
  var fileInput = document.getElementById('importTaskFile');
  var errDiv = document.getElementById('importTaskError');
  errDiv.style.display = 'none';
  if(!fileInput.files.length){ errDiv.textContent='请选择 Excel 文件'; errDiv.style.display=''; return; }

  var fd = new FormData();
  fd.append('file', fileInput.files[0]);
  fd.append('course_id', COURSE_ID);

  var btn = document.getElementById('importPreviewBtn');
  btn.disabled = true; btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span> 解析中...';

  fetch('{% url "preview_task_import" %}', {
    method:'POST', body:fd, headers:{'X-CSRFToken': CSRF}
  }).then(function(r){ return r.json().then(function(d){ return {ok:r.ok, data:d}; }); })
  .then(function(res){
    btn.disabled = false; btn.innerHTML = '<i class="bi bi-eye"></i> 预览';
    if(!res.ok){
      errDiv.textContent = res.data.error || '解析失败'; errDiv.style.display=''; return;
    }
    renderTaskPreview(res.data);
  }).catch(function(e){
    btn.disabled = false; btn.innerHTML = '<i class="bi bi-eye"></i> 预览';
    errDiv.textContent = '请求失败：' + e.message; errDiv.style.display='';
  });
}

function renderTaskPreview(data){
  document.getElementById('import-step-upload').style.display = 'none';
  document.getElementById('import-step-preview').style.display = '';
  document.getElementById('importPreviewBtn').style.display = 'none';
  document.getElementById('importConfirmBtn').style.display = '';

  var tasks = data.tasks;
  var newCount = 0, dupCount = 0;
  tasks.forEach(function(t){ t.duplicate ? dupCount++ : newCount++; });

  document.getElementById('importPreviewSummary').innerHTML =
    '课程：<strong>' + data.course_name + '</strong> &nbsp;|&nbsp; ' +
    '共 <strong>' + tasks.length + '</strong> 条 &nbsp;|&nbsp; ' +
    '新增 <strong class="text-success">' + newCount + '</strong> &nbsp; ' +
    '重复 <strong class="text-warning">' + dupCount + '</strong>（将跳过）';

  var tbody = document.getElementById('importPreviewBody');
  tbody.innerHTML = '';
  tasks.forEach(function(t, i){
    var ft = t.fileType || '*';
    var statusBadge;
    if (t.duplicate && t.dup_reason === 'file') {
      statusBadge = '<span class="badge bg-danger">文件内重复-跳过</span>';
    } else if (t.duplicate) {
      statusBadge = '<span class="badge bg-warning">已存在-跳过</span>';
    } else {
      statusBadge = '<span class="badge bg-success">新增</span>';
    }
    var row = '<tr' + (t.duplicate ? ' class="table-warning"' : '') + '>' +
      '<td>' + (i+1) + '</td>' +
      '<td>' + t.title + '</td>' +
      '<td style="max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">' + t.content + '</td>' +
      '<td>' + ft + '</td>' +
      '<td>' + (t.display ? '是' : '否') + '</td>' +
      '<td>' + statusBadge + '</td></tr>';
    tbody.innerHTML += row;
  });
}

/* ── 导入实验：确认写入 ── */
function doConfirmTaskImport(){
  var btn = document.getElementById('importConfirmBtn');
  btn.disabled = true; btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span> 写入中...';

  fetch('{% url "confirm_task_import" %}', {
    method:'POST', headers:{'X-CSRFToken': CSRF, 'Content-Type':'application/json'}
  }).then(function(r){ return r.json().then(function(d){ return {ok:r.ok, data:d}; }); })
  .then(function(res){
    var resultDiv = document.getElementById('import-step-result');
    document.getElementById('import-step-preview').style.display = 'none';
    document.getElementById('importConfirmBtn').style.display = 'none';
    resultDiv.style.display = '';
    if(res.ok && res.data.success){
      resultDiv.innerHTML = '<div class="alert alert-success"><i class="bi bi-check-circle"></i> ' + res.data.success + '</div>';
      setTimeout(function(){ location.reload(); }, 1500);
    } else {
      resultDiv.innerHTML = '<div class="alert alert-danger"><i class="bi bi-x-circle"></i> ' + (res.data.error || '写入失败') + '</div>';
    }
  }).catch(function(e){
    btn.disabled = false; btn.innerHTML = '<i class="bi bi-check-lg"></i> 确认导入';
    alert('请求失败：' + e.message);
  });
}

/* ── 导入实验：模态框关闭时重置 ── */
document.getElementById('importTaskModal')&&
document.getElementById('importTaskModal').addEventListener('hidden.bs.modal', function(){
  document.getElementById('import-step-upload').style.display = '';
  document.getElementById('import-step-preview').style.display = 'none';
  document.getElementById('import-step-result').style.display = 'none';
  document.getElementById('importPreviewBtn').style.display = '';
  document.getElementById('importConfirmBtn').style.display = 'none';
  document.getElementById('importTaskFile').value = '';
  document.getElementById('importTaskError').style.display = 'none';
  document.getElementById('importPreviewBody').innerHTML = '';
});

/* ── 保持 Tab 状态（刷新后记住选中 Tab） ── */
(function(){
  var key = 'courseTab_' + COURSE_ID;
  var saved = sessionStorage.getItem(key);
  if(saved){
    var tab = document.querySelector('[data-bs-target="'+saved+'"]');
    if(tab) new bootstrap.Tab(tab).show();
  }
  document.querySelectorAll('#courseTab button').forEach(function(btn){
    btn.addEventListener('shown.bs.tab', function(e){
      sessionStorage.setItem(key, e.target.getAttribute('data-bs-target'));
    });
  });
})();
</script>
{% endblock %}
