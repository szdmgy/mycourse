{% extends "base.html" %}
{% block title %}用户列表 - 实验报告收集系统{% endblock %}
{% block nav_admin %}active{% endblock %}

{% block content %}
<nav aria-label="breadcrumb" class="mb-3">
  <ol class="breadcrumb" style="font-size:.85rem;">
    <li class="breadcrumb-item"><a href="{% url 'manager' %}">管理员控制台</a></li>
    <li class="breadcrumb-item active">用户列表</li>
  </ol>
</nav>

<h2 class="mb-3"><i class="bi bi-people"></i> 用户列表</h2>

<!-- 教师列表 -->
<div class="card mb-3">
  <div class="card-header d-flex justify-content-between align-items-center">
    <strong><i class="bi bi-person-badge"></i> 教师</strong>
    <span class="badge bg-primary">{{ teacherList|length }} 人</span>
  </div>
  {% if teacherList %}
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-hover align-middle mb-0">
        <thead class="table-light">
          <tr><th style="width:40px;">#</th><th>工号</th><th>姓名</th><th>性别</th><th style="width:220px;">操作</th></tr>
        </thead>
        <tbody>
          {% for t in teacherList %}
          <tr>
            <td>{{ forloop.counter }}</td>
            <td>{{ t.user.username }}</td>
            <td>{{ t.name }}</td>
            <td>{% if t.gender == 'M' %}男{% else %}女{% endif %}</td>
            <td>
              <button class="btn btn-outline-warning btn-sm" onclick="resetPwd('{{ t.user.username }}', '{{ t.name|escapejs }}')">
                <i class="bi bi-key"></i> 重置密码
              </button>
              <a href="{% url 'removeUser' t.user.username %}" class="btn btn-outline-danger btn-sm"
                 onclick="return confirm('确定要删除教师 {{ t.name }}（{{ t.user.username }}）吗？')">
                <i class="bi bi-trash"></i> 删除
              </a>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
  {% else %}
  <div class="card-body"><p class="text-muted mb-0">暂无教师</p></div>
  {% endif %}
</div>

<!-- 学生列表 -->
<div class="card mb-3">
  <div class="card-header d-flex justify-content-between align-items-center">
    <strong><i class="bi bi-mortarboard"></i> 学生</strong>
    <span class="badge bg-primary">{{ studentList|length }} 人</span>
  </div>
  {% if studentList %}
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-hover align-middle mb-0">
        <thead class="table-light">
          <tr><th style="width:40px;">#</th><th>学号</th><th>姓名</th><th>性别</th><th style="width:220px;">操作</th></tr>
        </thead>
        <tbody>
          {% for s in studentList %}
          <tr>
            <td>{{ forloop.counter }}</td>
            <td>{{ s.user.username }}</td>
            <td>{{ s.name }}</td>
            <td>{% if s.gender == 'M' %}男{% else %}女{% endif %}</td>
            <td>
              <button class="btn btn-outline-warning btn-sm" onclick="resetPwd('{{ s.user.username }}', '{{ s.name|escapejs }}')">
                <i class="bi bi-key"></i> 重置密码
              </button>
              <a href="{% url 'removeUser' s.user.username %}" class="btn btn-outline-danger btn-sm"
                 onclick="return confirm('确定要删除学生 {{ s.name }}（{{ s.user.username }}）吗？')">
                <i class="bi bi-trash"></i> 删除
              </a>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
  {% else %}
  <div class="card-body"><p class="text-muted mb-0">暂无学生</p></div>
  {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
function resetPwd(username, displayName){
  if(!confirm('确定要重置 ' + displayName + '（' + username + '）的密码吗？')) return;
  $.ajax({
    url: '{% url "resetPassword" %}', type: 'POST',
    data: {user: username},
    headers: {'X-CSRFToken': '{{ csrf_token }}'},
    success: function(r){ alert(r); },
    error: function(){ alert('密码重置失败！'); }
  });
}
</script>
{% endblock %}
