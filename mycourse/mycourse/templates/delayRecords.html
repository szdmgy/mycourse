{% extends "base.html" %}
{% load static %}
{% block title %}异常作业记录 - {{ course.courseName }}{% endblock %}
{% block nav_courses %}active{% endblock %}

{% block content %}
<nav aria-label="breadcrumb" class="mb-3">
  <ol class="breadcrumb" style="font-size:.85rem;">
    <li class="breadcrumb-item"><a href="{% url 'teacherCourseList' %}">课程列表</a></li>
    <li class="breadcrumb-item"><a href="{% url 'teacherCourseChange' course.courseTerm course.courseName course.classNumber %}">{{ course.courseName }}</a></li>
    <li class="breadcrumb-item active">异常作业记录</li>
  </ol>
</nav>

<div class="card mb-3">
  <div class="card-body py-2">
    <div class="row" style="font-size:.85rem; color:#555;">
      <div class="col-md-3"><strong>学期：</strong>{{ course.courseTerm }}</div>
      <div class="col-md-3"><strong>课程：</strong>{{ course.courseName }}</div>
      <div class="col-md-3"><strong>班号：</strong>{{ course.classNumber }}</div>
      <div class="col-md-3"><strong>教师：</strong>{{ course.teachers }}</div>
    </div>
  </div>
</div>

<div class="d-flex justify-content-between align-items-center mb-3">
  <h2 class="mb-0"><i class="bi bi-exclamation-triangle"></i> 异常作业记录</h2>
  {% if records %}
  <button class="btn btn-outline-primary btn-sm" onclick="exportExcel()">
    <i class="bi bi-download"></i> 导出 Excel
  </button>
  {% endif %}
</div>

{% if records %}
<div class="table-responsive">
  <table class="table table-hover align-middle" id="dataTable">
    <thead class="table-light">
      <tr>
        <th style="width:40px;">#</th>
        <th>作业标题</th>
        <th>学号</th>
        <th>学生姓名</th>
        <th>上传时间</th>
        <th>截止日期</th>
        <th>记录状态</th>
      </tr>
    </thead>
    <tbody>
      {% for record in records %}
      <tr>
        <td>{{ forloop.counter }}</td>
        <td>{{ record.title }}</td>
        <td>{{ record.number }}</td>
        <td>{{ record.name }}</td>
        <td>{% if record.time %}{{ record.time|date:"Y-m-d H:i" }}{% else %}—{% endif %}</td>
        <td>{{ record.deadline|date:"Y-m-d" }}</td>
        <td>
          {% if record.status == '延期提交' %}
            <span class="badge badge-delay">{{ record.status }}</span>
          {% elif record.status == '未提交' %}
            <span class="badge badge-overdue">{{ record.status }}</span>
          {% endif %}
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% else %}
<div class="card p-4 text-center">
  <p style="color:#666;"><i class="bi bi-check-circle"></i> 暂无异常记录，全部正常</p>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/xlsx.mini.js' %}"></script>
<script>
function exportExcel(){
  var table = document.getElementById('dataTable');
  if(!table){ alert('没有数据可导出'); return; }
  var data = [];
  table.querySelectorAll('tr').forEach(function(row){
    var cells = Array.from(row.querySelectorAll('th, td')).map(function(c){ return c.textContent.trim(); });
    data.push(cells);
  });
  var wb = XLSX.utils.book_new();
  var ws = XLSX.utils.aoa_to_sheet(data);
  XLSX.utils.book_append_sheet(wb, ws, '异常作业记录');
  XLSX.writeFile(wb, '{{ course.courseName|escapejs }}{{ course.classNumber }}班_异常记录.xlsx');
}
</script>
{% endblock %}
