<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>课程信息</title>
    {% load static %}
    <link href="{% static 'css/teacherTasks.css' %}" rel="stylesheet"/>

    <link rel="stylesheet" href="{% static 'css/bootstrap.css' %}">
    <!-- jQuery文件。务必在bootstrap.min.js 之前引入 -->
    <script src="{% static 'js/jquery.min.js' %}"></script>
    <!-- bootstrap.bundle.min.js 用于弹窗、提示、下拉菜单，包含了 popper.min.js -->
    <script src="{% static 'js/popper.min.js' %}"></script>
    <!-- 最新的 Bootstrap 核心 JavaScript 文件 -->
    <script src="{% static 'js/bootstrap.min.js' %}"></script>
    {# 为全选、全不选、下载作业绑定事件  #}
    <script type="text/javascript" src="{% static 'js/teacherTasks.js' %}"></script>
</head>
<body>
<div class="container">
    <!-- 欢迎语句和注销 -->
    <div class="jumbotron ">
        <h1>{{ name }}</h1>
        <a href="{% url 'logout' %}" id="logout"> 注销</a>
        <a href="{% url 'teacherCourseList' %}" id="courseList-a"> 返回课程目录 </a>
        <a href="{% url 'delayRecords'  course.id %}" id="courseList-a"> 作业异常记录 </a>

    </div>
    <div class="modal-content changeCourseModal">
        <h1>课程信息</h1>
        <table class="table table-striped table-hover table-bordered">
            <tr>
                <td>学期</td>
                <td>编号</td>
                <td>名称</td>
                <td>班号</td>
                <td>老师</td>
            </tr>
            <tr>
                <td>{{ course.courseTerm }}</td>
                <td>{{ course.courseNumber }}</td>
                <td>{{ course.courseName }}</td>
                <td>{{ course.classNumber }}</td>
                <td>{{ course.teachers }}</td>
            </tr>
        </table>

        <h1>作业信息</h1>
        <table class="table table-striped table-hover table-bordered">
            <tr>
                <td>#</td>
                <td>作业名</td>
                <td>上传文件类型</td>
                <td>是否显示</td>
                <td>截止日期</td>
                <td>操作</td>
            </tr>

            {% for task, studentList in tasks %}
                <tr>
                    <td>{{ forloop.counter }}</td>
                    <td>{{ task.title }}</td>
                    <td>{{ task.uploadFileType }}</td>
                    <td>{% if task.display %}是{% else %}否{% endif %}</td>
                    <td>{{ task.deadline }}</td>
                    <td>
                        <button class="btn" type="button"><a href="{% url 'taskChange' task.id task.title %} ">编辑</a></button>
                        <button class="btn" type="button"><a href="{% url 'homeworkRecords' task.id task.title %} ">作业记录<span class="badge">{{ studentList.0 | length }}</span></a></button>
                    </td>
                </tr>
            {% endfor %}
        </table>

        <h1>学生信息</h1>
        <table class="table table-striped table-hover table-bordered">
            <tr>
                <td>#</td>
                <td>学号</td>
                <td>姓名</td>
                <td>性别</td>
                <td>操作</td>
            </tr>

            {% for student in selectCourseStudentList %}
                <tr>
                    <td>{{ forloop.counter }}</td>
                    <td>{{ student.user }}</td>
                    <td>{{ student.name }}</td>
                    <td>{% if student.gender == 'M' %}男{% endif %}{% if student.gender == 'F' %}女{% endif %}</td>
                    <td>
                        <button class="btn" type="button"><a href="{% url 'removeStudent' course.id student.user %}"
                                                             onclick="return confirm('是否要移除该学生？')">移除</a>
                        </button>
                        <button class="btn btn-primary" type="button" onclick="resetPassword({{ student.user }})">重置密码</button>
                    </td>

                </tr>
            {% endfor %}
        </table>

        <h1>添加课程学生</h1>
        <form action="/addStudentToCourseByTeacher/" method="post">
            {% csrf_token %}
            {#课程名、课程号#}
            <input type="hidden" name="courseID" value="{{ course.id }}">
            <div class="form-group newStudentName-div">
                <label for="newStudentName">学生姓名</label>
                <input class="form-control newStudentName-input" type="text" name="newStudentName" id="newStudentName"/>
            </div>

            <div class="form-group newStudentNumber-div">
                <label for="newStudentNumber">学号</label>
                <input class="form-control newStudentNumber-input" type="text" name="newStudentNumber"
                       id="newStudentNumber"/>
            </div>

            <div class="form-group newStudentGender-div">
                <label>性别</label>
                <p>
                    男<input class="newStudentGender-input" type="radio" name="newStudentGender" value="M"/>
                    女<input class="newStudentGender-input" type="radio" name="newStudentGender" value="F" checked/>
                </p>
            </div>

            <div class="form-group newStudent-div">
                <input id="addNewStudent-btn" type="submit" class="btn btn-primary newStudent-input" value="提交">
            </div>

        </form>

    </div>
</div>
 <meta name="csrf-token" content="{{ csrf_token }}">
<script type="text/javascript">
    // 获取 CSRF Token（从 meta 标签中读取，使用可选链避免 null 错误）
    const getCSRFToken = () => {
        const metaTag = document.querySelector('meta[name="csrf-token"]');
        return metaTag?.content || ''; // 若未找到则返回空字符串（理论上不会发生）
    };

    // 密码重置函数（使用驼峰命名规范）
    const resetPassword = (user) => {
        // 构造 AJAX 请求配置
        const ajaxConfig = {
            url: '{% url "resetPassword" %}', // Django 模板生成 URL
            type: 'POST',
            data: { 'user': user }, // 普通表单数据（非文件上传时无需额外处理）
            headers: {
                'X-CSRFToken': getCSRFToken() // 关键：通过请求头传递 CSRF Token
            },
            success: (response) => {
                // 替换 alert 为更友好的提示（如 Toast），此处保留示例
                alert(response);
            },
            error: (xhr, status, error) => {
                // 输出详细错误信息（调试用），用户提示更友好
                console.error(`密码重置失败 | 状态: ${status} | 错误: ${error}`);
                alert('密码重置失败，请稍后重试！');
            }
        };

        // 发送 AJAX 请求（默认异步，无需显式声明 async: true）
        $.ajax(ajaxConfig);
    };
</script>
</body>

</html>