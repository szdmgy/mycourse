{% extends "base.html" %}
{% load static %}
{% block title %}提交作业 - {{ task.title }}{% endblock %}
{% block nav_stu_courses %}active{% endblock %}

{% block extra_css %}
<style>
  .task-container { max-width: 860px; margin: 0 auto; }
  .upload-card { border: 2px dashed #dee2e6; border-radius: 8px; padding: 20px; transition: border-color .2s; }
  .upload-card:hover { border-color: #1a6b9b; }
  .upload-card.uploaded { border-color: #28a745; border-style: solid; background: #f8fff8; }
  .uploaded-file { display: flex; align-items: center; gap: 10px; padding: 8px 12px; background: #e8f5e9; border-radius: 6px; margin-top: 10px; }
  .uploaded-file i { color: #28a745; font-size: 1.1rem; }
</style>
{% endblock %}

{% block content %}
<div class="task-container">
  <nav aria-label="breadcrumb" class="mb-3">
    <ol class="breadcrumb" style="font-size:.85rem;">
      <li class="breadcrumb-item"><a href="{% url 'studentCourseList' %}">我的课程</a></li>
      <li class="breadcrumb-item"><a href="{% url 'studentCourse' course.courseTerm course.courseName course.classNumber %}">{{ course.courseName }}</a></li>
      <li class="breadcrumb-item active">{{ task.title }}</li>
    </ol>
  </nav>

  <div class="card mb-3">
    <div class="card-body">
      <h2 class="card-title mb-2">{{ task.title }}</h2>
      <div class="mb-2" style="font-size:.85rem; color:#555;">
        <strong>所属课程：</strong>{{ course.courseName }}（{{ course.classNumber }}班）
        &nbsp;|&nbsp;
        <strong>截止日期：</strong>
        <span {% if task.deadline < today %}style="color:#dc3545;"{% endif %}>
          {{ task.deadline|date:"Y年m月d日" }}
        </span>
      </div>
      <div class="card p-3 mb-0" style="background:#f8f9fa; white-space:pre-wrap;">{{ task.content }}</div>
    </div>
  </div>

  <h3 class="mb-3"><i class="bi bi-paperclip"></i> 附件上传</h3>

  <div class="upload-card {% if hw_file %}uploaded{% endif %}" id="upload-card">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <span class="fw-bold">
        <i class="bi bi-file-earmark"></i> 提交附件
      </span>
      <span style="font-size:.8rem; color:#888;">
        {% if task.fileType == '*' %}不限类型{% else %}仅 {{ task.fileType }}{% endif %}
      </span>
    </div>

    <form id="upload-form" class="d-flex align-items-center gap-2 flex-wrap">
      {% csrf_token %}
      <input type="file" name="file" id="fileInput" class="form-control form-control-sm"
             style="max-width:350px;"
             {% if task.fileType != '*' %}accept="{{ task.fileType }}"{% endif %}>
      <button type="button" class="btn btn-outline-primary btn-sm" onclick="doUpload()">
        <i class="bi bi-cloud-upload"></i> 上传
      </button>
    </form>

    <div id="upload-status">
      {% if hw_file %}
        <div class="uploaded-file">
          <i class="bi bi-check-circle-fill"></i>
          <a href="{% url 'download_homework_file' hw_file.id %}" class="text-decoration-none">
            {{ hw_file.standardName }}
          </a>
          <span style="font-size:.75rem; color:#888;">（点击下载 | 重新上传将覆盖）</span>
        </div>
      {% else %}
        <div class="mt-2" style="font-size:.85rem; color:#999;">
          <i class="bi bi-info-circle"></i> 尚未上传
        </div>
      {% endif %}
    </div>
  </div>

</div>
{% endblock %}

{% block extra_js %}
<script>
function doUpload() {
  var fileInput = document.getElementById('fileInput');
  if (!fileInput.files.length) {
    alert('请先选择文件');
    return;
  }
  var formData = new FormData(document.getElementById('upload-form'));
  formData.append('taskId', '{{ task.id }}');

  $.ajax({
    url: '{% url "upload_file" %}',
    type: 'POST',
    data: formData,
    cache: false,
    contentType: false,
    processData: false,
    success: function(data) {
      if (data === 'YES') {
        alert('上传成功！');
        window.location.reload();
      } else {
        alert(data || '上传失败');
      }
    },
    error: function() {
      alert('上传失败，请检查文件格式！');
    }
  });
}
</script>
{% endblock %}
