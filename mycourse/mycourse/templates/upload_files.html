<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>åŠ¨æ€æ–‡ä»¶ä¸Šä¼ å·¥å…·</title>
    {% load static %}
    <link href="{% static 'css/studentCourseList.css' %}" rel="stylesheet"/>
    <link rel="stylesheet" href="{% static 'css/bootstrap.css' %}">
  <style>
    .container {
      max-width: 1200px;
      margin: 20px auto;
      padding: 25px;
      background: white;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .upload-area {
      border: 2px dashed #4a9ff5;
      border-radius: 8px;
      padding: 30px;
      text-align: center;
      cursor: pointer;
      background: #f0f7ff;
      transition: all 0.3s;
      margin-bottom: 20px;
    }
    .upload-area.drag-over {
      background: #e1effe;
      border-color: #007bff;
    }
    .file-list {
      margin: 20px 0;
      border-top: 1px solid #dee2e6;
      padding-top: 15px;
    }
    .file-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 15px;
      border-bottom: 1px solid #eee;
    }
    .file-info {
      display: flex;
      align-items: center;
    }
    .file-icon {
      margin-right: 10px;
      font-size: 18px;
    }
    .file-actions {
      display: flex;
      gap: 10px;
    }
    .delete-btn {
      color: #dc3545;
      cursor: pointer;
      background: none;
      border: none;
      font-size: 16px;
    }
    .progress-bar {
      height: 8px;
      background: #e9ecef;
      border-radius: 4px;
      margin: 25px 0;
      overflow: hidden;
      display: none;
    }
    .progress-fill {
      height: 100%;
      background: #4a9ff5;
      width: 0%;
      transition: width 0.3s;
    }
    .button-group {
      display: flex;
      gap: 15px;
      justify-content: center;
    }
    .process-btn, .reset-btn {
      padding: 10px 25px;
      font-size: 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .process-btn {
      background: #28a745;
      color: white;
    }
    .process-btn:disabled {
      background: #b4b9bd;
      cursor: not-allowed;
    }
    .reset-btn {
      background: #f8f9fa;
      border: 1px solid #ced4da;
    }
    .results {
      margin-top: 30px;
      background: #f8f9fa;
      border-radius: 8px;
      padding: 20px;
      display: none;
    }
    .error {
      color: #dc3545;
      padding: 10px;
      border-radius: 4px;
      background: #fff0f0;
    }
    .success {
      color: #28a745;
    }
    .stats-panel {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 20px;
      text-align: center;
      display: none;
    }



    /* æ–‡ä»¶ä¸Šä¼ åŒºåŸŸæ ·å¼ */
.upload-drop-zone {
  border: 2px dashed #ddd;
  border-radius: 4px;
  padding: 30px; /* å¢åŠ å†…è¾¹è·ä»¥å®¹çº³æ›´å¤§çš„å­—ä½“ */
  background-color: #f8f9fa;
  text-align: center;
  position: relative;
  transition: all 0.3s ease;
}

/* ä¸Šä¼ å†…å®¹æ ·å¼ */
.drop-zone-content {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  height: 100%;
}

/* å¢å¤§æ–‡æœ¬å­—ä½“ */
.drag-text, .or-text {
  font-size: 18px; /* å¢å¤§çš„å­—ä½“å¤§å° */
  color: #333;
  margin-bottom: 15px;
}

/* é€‰æ‹©æ–‡ä»¶æŒ‰é’®æ ·å¼ - å¢å¤§å¹¶é€‚é… */
.select-file-btn {
  font-size: 16px; /* å¢å¤§çš„æŒ‰é’®å­—ä½“ */
  padding: 8px 20px; /* å¢åŠ æŒ‰é’®å†…è¾¹è· */
  background-color: #fff;
  border: 1px solid #ddd;
  border-radius: 4px;
  cursor: pointer;
  transition: all 0.3s ease;
  box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

.select-file-btn:hover {
  background-color: #f0f0f0;
}

/* æ–‡ä»¶ä¿¡æ¯åŒºåŸŸæ ·å¼ */
.file-info {
  margin-top: 10px;
  padding-left: 15px;
}

.file-label {
  font-size: 16px; /* å¢å¤§çš„æ ‡ç­¾å­—ä½“ */
  color: #333;
  display: block;
  margin-bottom: 5px;
}

.file-status {
  font-size: 14px; /* å¢å¤§çš„çŠ¶æ€å­—ä½“ */
  color: #666;
}
  </style>
</head>
<body>
  <div class="container">

       <!-- æ¬¢è¿è¯­å¥å’Œæ³¨é”€ -->
    <div class="jumbotron ">
        <h1>{{ name }}</h1>
        <a href="{% url 'logout' %}" id="logout"> æ³¨é”€</a>
        <a href="{% url 'manager' %}" id="courseList-a"> è¿”å›ç®¡ç†å‘˜ç•Œé¢ </a>
    </div>

    <div>
        <h2>{{ file_text }}</h2>

        <!-- CSRFä»¤ç‰Œ -->
        <input type="hidden" id="csrf-token" value="{{ csrf_token }}">

          <!-- æ·»åŠ éšè—çš„datatypeå­—æ®µ -->
        <input type="hidden" id="datatype" value={{ datatype }}>
        <!-- ä¸Šä¼ åŒºåŸŸ -->
        <div id="upload-area" class="upload-area">
          <div class="file-icon">ğŸ“</div>
          <p class="drag-text">æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„</p>
          <p class="drag-text">æˆ–</p>
          <button id="file-browse-btn" class="drag-text">é€‰æ‹©æ–‡ä»¶</button>
          <input type="file" id="file-input"  class="drag-text" multiple accept="{{ allowed_extensions }}" hidden>
        </div>

        <!-- ç»Ÿè®¡é¢æ¿ -->
        <div id="stats-panel" class="stats-panel">
          <span>æ€»æ–‡ä»¶: <span id="total-files">0</span></span>
          <span style="margin: 0 15px;">|</span>
          <span>æ€»å¤§å°: <span id="total-size">0B</span></span>
        </div>

        <!-- æ–‡ä»¶åˆ—è¡¨ -->
        <div id="file-list" class="file-list">
          <div class="file-item empty-list drag-text" >æœªé€‰æ‹©ä»»ä½•æ–‡ä»¶</div>
        </div>

        <!-- è¿›åº¦æ¡ -->
        <div id="progress-container" class="progress-bar">
          <div id="progress-fill" class="progress-fill"></div>
        </div>

        <!-- æ“ä½œæŒ‰é’® -->
        <div class="button-group">
          <button id="process-btn" class="process-btn" disabled>ä¸Šä¼ æ–‡ä»¶</button>
          <button id="reset-btn" class="reset-btn">é‡ç½®</button>
        </div>

        <!-- ç»“æœæ˜¾ç¤º -->
        <div id="results" class="results">
             <div class="results-title">å¤„ç†ç»“æœ</div>
          <div id="results-content"></div> <!-- ç¡®ä¿æœ‰results-contentå…ƒç´  -->
        </div>
  </div>

    </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {

      // è·å–CSRFä»¤ç‰Œ
      const csrfToken = document.getElementById('csrf-token').value;

      // è·å–åç«¯è®¾ç½®çš„æ–‡ä»¶ç±»å‹
      const allowedExtensions = "{{ allowed_extensions }}";

      // DOMå…ƒç´ 
      const uploadArea = document.getElementById('upload-area');
      const fileInput = document.getElementById('file-input');
      const fileBrowseBtn = document.getElementById('file-browse-btn');
      const fileList = document.getElementById('file-list');
      const processBtn = document.getElementById('process-btn');
      const resetBtn = document.getElementById('reset-btn');
      const progressContainer = document.getElementById('progress-container');
      const progressFill = document.getElementById('progress-fill');
      const resultsDiv = document.getElementById('results');
      const statsPanel = document.getElementById('stats-panel');
      const totalFilesSpan = document.getElementById('total-files');
      const totalSizeSpan = document.getElementById('total-size');

      // æ–‡ä»¶æ•°æ®
      const filesData = {
        selectedFiles: []
      };

      // äº‹ä»¶ç»‘å®š
      fileBrowseBtn.addEventListener('click', () => fileInput.click());
      fileInput.addEventListener('change', handleFileSelect);
      uploadArea.addEventListener('dragover', handleDragOver);
      uploadArea.addEventListener('dragleave', handleDragLeave);
      uploadArea.addEventListener('drop', handleDrop);
      processBtn.addEventListener('click', processFiles);
      resetBtn.addEventListener('click', resetAll);

      // æ‹–æ”¾å¤„ç†
      function handleDragOver(e) {
        e.preventDefault();
        uploadArea.classList.add('drag-over');
      }

      function handleDragLeave(e) {
        e.preventDefault();
        uploadArea.classList.remove('drag-over');
      }

      function handleDrop(e) {
        e.preventDefault();
        uploadArea.classList.remove('drag-over');
        if (e.dataTransfer.files.length > 0) {

          handleFiles([...e.dataTransfer.files]);
        }
      }

      // æ–‡ä»¶é€‰æ‹©å¤„ç†
      function handleFileSelect(e) {
        if (e.target.files.length > 0) {

          handleFiles([...e.target.files]);
        }
      }

      // æ·»åŠ æ–‡ä»¶
      function handleFiles(newFiles) {
        // ä½¿ç”¨åç«¯æŒ‡å®šçš„æ‰©å±•åè¿‡æ»¤æ–‡ä»¶
        const validExtensions = allowedExtensions.split(',').map(ext => ext.trim().toLowerCase());
        const validFiles = newFiles.filter(file => {
          const extension = '.' + file.name.split('.').pop().toLowerCase();
          return validExtensions.includes(extension);
        });



        if (validFiles.length === 0) {
          alert(`è¯·é€‰æ‹©æœ‰æ•ˆæ–‡ä»¶ç±»å‹: ${allowedExtensions}`);
          return;
        }

        // æ·»åŠ åˆ°æ–‡ä»¶åˆ—è¡¨
        filesData.selectedFiles = [...filesData.selectedFiles, ...validFiles];
        updateFileList();
        processBtn.disabled = false;
        statsPanel.style.display = 'block';
      }

      // æ›´æ–°æ–‡ä»¶åˆ—è¡¨æ˜¾ç¤º
      function updateFileList() {
        // ç§»é™¤ç©ºåˆ—è¡¨æç¤º
        const emptyList = document.querySelector('.empty-list');
        if (emptyList) emptyList.remove();

        fileList.innerHTML = '';

        filesData.selectedFiles.forEach((file, index) => {
          const fileDiv = document.createElement('div');
          fileDiv.className = 'file-item';
          fileDiv.innerHTML = `
            <div class="file-info">
              <div class="file-icon">${getFileIcon(file.name)}</div>
              <div>${file.name} (${formatFileSize(file.size)})</div>
            </div>
            <div class="file-actions">
              <button class="delete-btn" data-index="${index}">Ã—</button>
            </div>
          `;
          fileList.appendChild(fileDiv);
        });

        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        updateStats();

        // æ·»åŠ åˆ é™¤äº‹ä»¶
        document.querySelectorAll('.delete-btn').forEach(btn => {
          btn.addEventListener('click', function() {
            const index = parseInt(this.getAttribute('data-index'));
            filesData.selectedFiles.splice(index, 1);
            updateFileList();

            if (filesData.selectedFiles.length === 0) {
              resetUI();
            }
          });
        });
      }

      // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
      function updateStats() {
        totalFilesSpan.textContent = filesData.selectedFiles.length;

        const totalSize = filesData.selectedFiles.reduce((sum, file) => sum + file.size, 0);
        totalSizeSpan.textContent = formatFileSize(totalSize);
      }

      // æ ¹æ®æ–‡ä»¶æ‰©å±•åè·å–å›¾æ ‡
      function getFileIcon(filename) {
        const extension = filename.split('.').pop().toLowerCase();

        const iconMap = {
          'doc': 'ğŸ“', 'docx': 'ğŸ“„', 'xls': 'ğŸ“Š', 'xlsx': 'ğŸ“ˆ',
          'csv': 'ğŸ“‹', 'pdf': 'ğŸ“‘', 'rar': 'ğŸ“¦', 'zip': 'ğŸ“¦',
          'txt': 'ğŸ“„', 'jpg': 'ğŸ–¼ï¸', 'jpeg': 'ğŸ–¼ï¸', 'png': 'ğŸ–¼ï¸'
        };

        return iconMap[extension] || 'ğŸ“';
      }

      // å¤„ç†æ–‡ä»¶
      async function processFiles() {
        if (filesData.selectedFiles.length === 0) return;
        if (processBtn.disabled) return;

        processBtn.disabled = true;
        processBtn.textContent = 'ä¸Šä¼ ä¸­...';
        resultsDiv.style.display = 'none';
        progressContainer.style.display = 'block';
        progressFill.style.width = '0%';

        // ä½¿ç”¨FormDataåŒ…è£…æ‰€æœ‰æ–‡ä»¶
        const formData = new FormData();
        filesData.selectedFiles.forEach((file, index) => {
          formData.append(`file_${index}`, file);
           // ä»éšè—å­—æ®µè·å–datatypeçš„å€¼
        const dataType = document.getElementById('datatype').value;
          formData.append('datatype', dataType);
        });

        try {
          // å‘é€è¯·æ±‚åˆ°æœåŠ¡å™¨
          const response = await fetch('{% url "process_files" %}', {
            method: 'POST',
            body: formData,
            headers: {
              'X-CSRFToken': csrfToken
            }
          });

          if (!response.ok) {
            throw new Error(`æœåŠ¡å™¨é”™è¯¯: ${response.statusText}`);
          }

          const result = await response.json();
          console.log(result)
          displayResults(result);
          progressFill.style.width = '100%';
        } catch (error) {
          console.error('å¤„ç†é”™è¯¯:', error);
          resultsDiv.innerHTML = `<div class="error">å¤„ç†å¤±è´¥: ${error.message || 'æœªçŸ¥é”™è¯¯'}</div>`;
          resultsDiv.style.display = 'block';

          // é‡ç½®æŒ‰é’®çŠ¶æ€
          processBtn.disabled = false;
          processBtn.textContent = 'ä¸Šä¼ æ–‡ä»¶';
        }
      }

      // æ˜¾ç¤ºå¤„ç†ç»“æœ
      function displayResults(data) {
        resultsDiv.innerHTML = '';

        if (data.success) {
          let html = `<h3 class="success">ä¸Šä¼ æˆåŠŸ (${data.file_count} ä¸ªæ–‡ä»¶)</h3>`;

          data.results.forEach(result => {
            html += `<div class="file-item">
              <div class="file-info">
                <div class="file-icon">${result.error ? 'âŒ' : 'âœ…'}</div>
                <div><strong>${result.filename}</strong></div>
              </div>
            </div>`;

            if (result.error) {
              html += `<div class="error" style="margin-left: 40px; margin-top: 8px;">${result.error}</div>`;
            } /*else {
              html += `<div style="margin-left: 40px; margin-top: 8px;">`;
              result.sheets.forEach(sheet => {
                html += `<div>${sheet.name}: ${sheet.row_count} è¡Œæ•°æ®</div>`;
              });
              html += `</div>`;
            }*/
          });

          resultsDiv.innerHTML = html;
        } else {
          resultsDiv.innerHTML = `<div class="error">å¤„ç†å¤±è´¥: ${data.error || 'æœªçŸ¥é”™è¯¯'}</div>`;
        }

        resultsDiv.style.display = 'block';
      }

      // é‡ç½®UIçŠ¶æ€
      function resetUI() {
        processBtn.disabled = true;
        processBtn.textContent = 'ä¸Šä¼ æ–‡ä»¶';
        progressContainer.style.display = 'none';
        progressFill.style.width = '0%';
        statsPanel.style.display = 'none';
        resultsDiv.style.display = 'none';

        // æ¢å¤ç©ºåˆ—è¡¨æç¤º
        fileList.innerHTML = '<div class="file-item empty-list">æœªé€‰æ‹©ä»»ä½•æ–‡ä»¶</div>';
      }

      // é‡ç½®å…¨éƒ¨
      function resetAll() {
        filesData.selectedFiles = [];
        fileInput.value = '';
        resetUI();
      }

      // è¾…åŠ©å‡½æ•°ï¼šæ ¼å¼åŒ–æ–‡ä»¶å¤§å°
      function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
      }
    });
  </script>
</body>
</html>
