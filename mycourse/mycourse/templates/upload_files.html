{% extends "base.html" %}
{% load static %}
{% block title %}{{ file_text }} - å®éªŒæŠ¥å‘Šæ”¶é›†ç³»ç»Ÿ{% endblock %}
{% block nav_admin %}active{% endblock %}

{% block extra_css %}
<style>
  .upload-area {
    border: 2px dashed #4a9ff5; border-radius: 8px; padding: 40px;
    text-align: center; cursor: pointer; background: #f0f7ff; transition: all .3s;
  }
  .upload-area.drag-over { background: #e1effe; border-color: #007bff; }
  .upload-area .bi { font-size: 2.5rem; color: #4a9ff5; }
  .file-item {
    display: flex; align-items: center; justify-content: space-between;
    padding: 10px 15px; border-bottom: 1px solid #eee;
  }
  .file-info { display: flex; align-items: center; gap: 10px; }
  .file-icon { font-size: 1.2rem; }
  .delete-btn { color: #dc3545; cursor: pointer; background: none; border: none; font-size: 1.2rem; }
  .progress-bar-custom { height: 8px; background: #e9ecef; border-radius: 4px; overflow: hidden; display: none; margin: 20px 0; }
  .progress-fill { height: 100%; background: #4a9ff5; width: 0%; transition: width .3s; }
  .results { margin-top: 20px; display: none; }
</style>
{% endblock %}

{% block content %}
<nav aria-label="breadcrumb" class="mb-3">
  <ol class="breadcrumb" style="font-size:.85rem;">
    <li class="breadcrumb-item"><a href="{% url 'manager' %}">ç®¡ç†å‘˜æ§åˆ¶å°</a></li>
    <li class="breadcrumb-item active">{{ file_text }}</li>
  </ol>
</nav>

<h2 class="mb-3"><i class="bi bi-cloud-upload"></i> {{ file_text }}</h2>

<input type="hidden" id="csrf-token" value="{{ csrf_token }}">
<input type="hidden" id="datatype" value="{{ datatype }}">

<div class="card">
  <div class="card-body">
    <!-- æ‹–æ‹½ä¸Šä¼ åŒºåŸŸ -->
    <div id="upload-area" class="upload-area mb-3">
      <i class="bi bi-folder2-open d-block mb-2"></i>
      <p class="mb-1">æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„</p>
      <p class="mb-2" style="color:#999;">æˆ–</p>
      <button id="file-browse-btn" class="btn btn-outline-primary">
        <i class="bi bi-file-earmark-plus"></i> é€‰æ‹©æ–‡ä»¶
      </button>
      <input type="file" id="file-input" multiple accept="{{ allowed_extensions }}" hidden>
    </div>

    <!-- ç»Ÿè®¡é¢æ¿ -->
    <div id="stats-panel" class="alert alert-info py-2 text-center" style="display:none;">
      æ€»æ–‡ä»¶ï¼š<strong id="total-files">0</strong> &nbsp;|&nbsp;
      æ€»å¤§å°ï¼š<strong id="total-size">0B</strong>
    </div>

    <!-- æ–‡ä»¶åˆ—è¡¨ -->
    <div id="file-list">
      <div class="file-item empty-list" style="color:#999; text-align:center;">æœªé€‰æ‹©ä»»ä½•æ–‡ä»¶</div>
    </div>

    <!-- è¿›åº¦æ¡ -->
    <div id="progress-container" class="progress-bar-custom">
      <div id="progress-fill" class="progress-fill"></div>
    </div>

    <!-- æ“ä½œæŒ‰é’® -->
    <div class="d-flex gap-2 justify-content-center mt-3">
      <button id="process-btn" class="btn btn-success" disabled>
        <i class="bi bi-upload"></i> ä¸Šä¼ æ–‡ä»¶
      </button>
      <button id="reset-btn" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-counterclockwise"></i> é‡ç½®
      </button>
    </div>

    <!-- ç»“æœæ˜¾ç¤º -->
    <div id="results" class="results"></div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  var csrfToken = document.getElementById('csrf-token').value;
  var allowedExtensions = "{{ allowed_extensions }}";

  var uploadArea = document.getElementById('upload-area');
  var fileInput = document.getElementById('file-input');
  var fileBrowseBtn = document.getElementById('file-browse-btn');
  var fileList = document.getElementById('file-list');
  var processBtn = document.getElementById('process-btn');
  var resetBtn = document.getElementById('reset-btn');
  var progressContainer = document.getElementById('progress-container');
  var progressFill = document.getElementById('progress-fill');
  var resultsDiv = document.getElementById('results');
  var statsPanel = document.getElementById('stats-panel');
  var totalFilesSpan = document.getElementById('total-files');
  var totalSizeSpan = document.getElementById('total-size');

  var selectedFiles = [];

  fileBrowseBtn.addEventListener('click', function(){ fileInput.click(); });
  fileInput.addEventListener('change', function(e){ if(e.target.files.length) handleFiles([...e.target.files]); });
  uploadArea.addEventListener('dragover', function(e){ e.preventDefault(); uploadArea.classList.add('drag-over'); });
  uploadArea.addEventListener('dragleave', function(e){ e.preventDefault(); uploadArea.classList.remove('drag-over'); });
  uploadArea.addEventListener('drop', function(e){
    e.preventDefault(); uploadArea.classList.remove('drag-over');
    if(e.dataTransfer.files.length) handleFiles([...e.dataTransfer.files]);
  });
  processBtn.addEventListener('click', doUpload);
  resetBtn.addEventListener('click', resetAll);

  function handleFiles(newFiles){
    var exts = allowedExtensions.split(',').map(function(e){ return e.trim().toLowerCase(); });
    var valid = newFiles.filter(function(f){
      return exts.includes('.' + f.name.split('.').pop().toLowerCase());
    });
    if(!valid.length){ alert('è¯·é€‰æ‹©æœ‰æ•ˆæ–‡ä»¶ç±»å‹: ' + allowedExtensions); return; }
    selectedFiles = selectedFiles.concat(valid);
    updateFileList();
    processBtn.disabled = false;
    statsPanel.style.display = '';
  }

  function updateFileList(){
    fileList.innerHTML = '';
    selectedFiles.forEach(function(f, i){
      var div = document.createElement('div');
      div.className = 'file-item';
      div.innerHTML = '<div class="file-info"><span class="file-icon">' + getIcon(f.name) + '</span><span>' + f.name + ' (' + fmtSize(f.size) + ')</span></div>' +
        '<button class="delete-btn" data-idx="' + i + '"><i class="bi bi-x-lg"></i></button>';
      fileList.appendChild(div);
    });
    totalFilesSpan.textContent = selectedFiles.length;
    var total = selectedFiles.reduce(function(s,f){ return s+f.size; }, 0);
    totalSizeSpan.textContent = fmtSize(total);

    fileList.querySelectorAll('.delete-btn').forEach(function(btn){
      btn.addEventListener('click', function(){
        selectedFiles.splice(parseInt(this.dataset.idx), 1);
        if(!selectedFiles.length) resetUI(); else updateFileList();
      });
    });
  }

  function getIcon(name){
    var ext = name.split('.').pop().toLowerCase();
    var m = {xls:'ğŸ“Š',xlsx:'ğŸ“ˆ',xlsm:'ğŸ“ˆ',doc:'ğŸ“',docx:'ğŸ“„',pdf:'ğŸ“‘',zip:'ğŸ“¦',rar:'ğŸ“¦'};
    return m[ext] || 'ğŸ“';
  }

  async function doUpload(){
    if(!selectedFiles.length || processBtn.disabled) return;
    processBtn.disabled = true;
    processBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span> ä¸Šä¼ ä¸­...';
    resultsDiv.style.display = 'none';
    progressContainer.style.display = '';
    progressFill.style.width = '0%';

    var fd = new FormData();
    var dt = document.getElementById('datatype').value;
    selectedFiles.forEach(function(f, i){
      fd.append('file_' + i, f);
      fd.append('datatype', dt);
    });

    try {
      var resp = await fetch('{% url "process_files" %}', {
        method: 'POST', body: fd, headers: {'X-CSRFToken': csrfToken}
      });
      if(!resp.ok) throw new Error('æœåŠ¡å™¨é”™è¯¯: ' + resp.statusText);
      var data = await resp.json();
      progressFill.style.width = '100%';
      showResults(data);
    } catch(err) {
      resultsDiv.innerHTML = '<div class="alert alert-danger">å¤„ç†å¤±è´¥: ' + (err.message || 'æœªçŸ¥é”™è¯¯') + '</div>';
      resultsDiv.style.display = '';
      processBtn.disabled = false;
      processBtn.innerHTML = '<i class="bi bi-upload"></i> ä¸Šä¼ æ–‡ä»¶';
    }
  }

  function showResults(data){
    var html = '';
    if(data.success){
      html += '<div class="alert alert-success"><strong>ä¸Šä¼ æˆåŠŸ</strong>ï¼ˆ' + data.file_count + ' ä¸ªæ–‡ä»¶ï¼‰</div>';
      (data.results || []).forEach(function(r){
        html += '<div class="file-item"><div class="file-info"><span class="file-icon">' +
          (r.error ? 'âŒ' : 'âœ…') + '</span><strong>' + r.filename + '</strong></div></div>';
        if(r.error) html += '<div class="alert alert-danger py-1 ms-4" style="font-size:.85rem;">' + r.error + '</div>';
      });
    } else {
      html = '<div class="alert alert-danger">å¤„ç†å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯') + '</div>';
    }
    resultsDiv.innerHTML = html;
    resultsDiv.style.display = '';
  }

  function resetUI(){
    processBtn.disabled = true;
    processBtn.innerHTML = '<i class="bi bi-upload"></i> ä¸Šä¼ æ–‡ä»¶';
    progressContainer.style.display = 'none';
    progressFill.style.width = '0%';
    statsPanel.style.display = 'none';
    resultsDiv.style.display = 'none';
    fileList.innerHTML = '<div class="file-item empty-list" style="color:#999;text-align:center;">æœªé€‰æ‹©ä»»ä½•æ–‡ä»¶</div>';
  }

  function resetAll(){
    selectedFiles = [];
    fileInput.value = '';
    resetUI();
  }

  function fmtSize(b){
    if(!b) return '0 B';
    var k=1024, s=['B','KB','MB','GB'], i=Math.floor(Math.log(b)/Math.log(k));
    return parseFloat((b/Math.pow(k,i)).toFixed(2))+' '+s[i];
  }
});
</script>
{% endblock %}
