{% extends "base.html" %}
{% load static %}
{% block title %}作业记录 - {{ task.title }}{% endblock %}
{% block nav_courses %}active{% endblock %}

{% block content %}
<nav aria-label="breadcrumb" class="mb-3">
  <ol class="breadcrumb" style="font-size:.85rem;">
    <li class="breadcrumb-item"><a href="{% url 'teacherCourseList' %}">课程列表</a></li>
    <li class="breadcrumb-item"><a href="{% url 'teacherCourseChange' course.courseTerm course.courseName course.classNumber %}">{{ course.courseName }}</a></li>
    <li class="breadcrumb-item active">{{ task.title }} — 作业记录</li>
  </ol>
</nav>

<div class="card mb-3">
  <div class="card-body py-2">
    <div class="row" style="font-size:.85rem; color:#555;">
      <div class="col-md-3"><strong>课程：</strong>{{ course.courseName }}</div>
      <div class="col-md-3"><strong>作业：</strong>{{ task.title }}</div>
      <div class="col-md-3"><strong>截止日期：</strong>{{ task.deadline|date:"Y-m-d" }}</div>
      <div class="col-md-3"><strong>附件要求：</strong>{{ task.maxFiles }} 个</div>
    </div>
  </div>
</div>

<!-- 未提交学生 -->
<div class="card mb-3">
  <div class="card-header d-flex justify-content-between align-items-center">
    <strong><i class="bi bi-x-circle"></i> 未提交学生</strong>
    <span class="badge bg-danger">{{ notSubmitStudents|length }} 人</span>
  </div>
  {% if notSubmitStudents %}
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-hover align-middle mb-0">
        <thead class="table-light">
          <tr><th style="width:40px;">#</th><th>学号</th><th>姓名</th><th>性别</th></tr>
        </thead>
        <tbody>
          {% for stu in notSubmitStudents %}
          <tr>
            <td>{{ forloop.counter }}</td>
            <td>{{ stu.number }}</td>
            <td>{{ stu.name }}</td>
            <td>{% if stu.gender == 'M' %}男{% else %}女{% endif %}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
  {% else %}
  <div class="card-body"><p class="text-muted mb-0">全部已提交</p></div>
  {% endif %}
</div>

<!-- 已提交学生 -->
<div class="card mb-3">
  <div class="card-header d-flex justify-content-between align-items-center">
    <strong><i class="bi bi-check-circle"></i> 已提交学生</strong>
    <span class="badge bg-success">{{ submitRecords|length }} 人</span>
  </div>
  {% if submitRecords %}
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-hover align-middle mb-0">
        <thead class="table-light">
          <tr>
            <th style="width:40px;">#</th><th>学号</th><th>姓名</th><th>性别</th>
            <th>提交时间</th><th>附件</th><th>延期</th>
            <th>
              选择
              <a href="javascript:void(0)" onclick="selAll()" class="ms-2 text-primary" style="font-size:.8rem;">全选</a>
              <a href="javascript:void(0)" onclick="selNone()" class="ms-1 text-primary" style="font-size:.8rem;">全不选</a>
            </th>
          </tr>
        </thead>
        <tbody>
          {% for rec in submitRecords %}
          <tr {% if rec.delay %}class="table-warning"{% endif %}>
            <td>{{ forloop.counter }}</td>
            <td>{{ rec.number }}</td>
            <td>{{ rec.name }}</td>
            <td>{% if rec.gender == 'M' %}男{% else %}女{% endif %}</td>
            <td>{{ rec.time|date:"Y-m-d H:i" }}</td>
            <td>{{ rec.submitted_count }}/{{ rec.required_count }}</td>
            <td>{% if rec.delay %}<span class="badge badge-delay">是</span>{% else %}<span class="badge badge-submitted">否</span>{% endif %}</td>
            <td><input type="checkbox" class="form-check-input hw-chk" data-number="{{ rec.number }}"></td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    <div class="card-body pt-2">
      <button class="btn btn-primary btn-sm" onclick="dlHomework()">
        <i class="bi bi-download"></i> 下载选中作业
      </button>
    </div>
  </div>
  {% else %}
  <div class="card-body"><p class="text-muted mb-0">暂无人提交</p></div>
  {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
function selAll(){ document.querySelectorAll('.hw-chk').forEach(function(c){c.checked=true;}); }
function selNone(){ document.querySelectorAll('.hw-chk').forEach(function(c){c.checked=false;}); }

function dlHomework(){
  var list = [];
  document.querySelectorAll('.hw-chk:checked').forEach(function(c){ list.push(c.dataset.number); });
  if(!list.length){ alert('请先勾选要下载的学生作业！'); return; }

  var xhr = new XMLHttpRequest();
  xhr.open('POST', '{% url "download_homework_ByTeacher" %}', true);
  xhr.responseType = 'blob';
  xhr.setRequestHeader('X-CSRFToken', '{{ csrf_token }}');
  xhr.setRequestHeader('Content-Type', 'application/json');
  xhr.onload = function(){
    if(this.status === 200){
      var disp = this.getResponseHeader('Content-Disposition');
      var fn = decodeURI(escape(disp.substring(20)));
      var a = document.createElement('a');
      a.href = URL.createObjectURL(new Blob([this.response]));
      a.download = fn; a.click();
    }
  };
  xhr.send(JSON.stringify({
    taskName: '{{ task.title|escapejs }}',
    taskId: {{ task.id }},
    studentNumberList: list
  }));
}
</script>
{% endblock %}
