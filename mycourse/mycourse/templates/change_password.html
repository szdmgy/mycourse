{% extends "base.html" %}
{% block title %}修改密码 - 实验报告收集系统{% endblock %}

{% block extra_css %}
<style>
  .pwd-container { max-width: 520px; margin: 0 auto; }
  .form-group { margin-bottom: 1.5rem; }
  .error-msg { color: #dc3545; margin: 12px 0; padding: 12px 15px; background: #f8d7da; border: 1px solid #f5c6cb; border-radius: 6px; }
  .success-msg { color: #155724; margin: 12px 0; padding: 12px 15px; background: #d4edda; border: 1px solid #c3e6cb; border-radius: 6px; }
</style>
{% endblock %}

{% block content %}
<div class="pwd-container">
  <h2 class="mb-4 text-center">修改密码</h2>

  {% if success_msg %}
    <div class="success-msg"><i class="bi bi-check-circle"></i> {{ success_msg }}</div>
  {% endif %}
  {% if error_msg %}
    <div class="error-msg"><i class="bi bi-exclamation-triangle"></i> {{ error_msg }}</div>
  {% endif %}
  {% if form.non_field_errors %}
    <div class="error-msg">{{ form.non_field_errors.0 }}</div>
  {% endif %}

  <div class="card p-4">
    <form method="post" novalidate>
      {% csrf_token %}

      <div class="form-group">
        <label for="{{ form.old_password.id_for_label }}" class="form-label">旧密码</label>
        <input type="password"
               class="form-control {% if form.old_password.errors %}is-invalid{% endif %}"
               id="{{ form.old_password.id_for_label }}"
               name="{{ form.old_password.name }}"
               value="{{ form.old_password.value|default_if_none:'' }}"
               required>
        {% if form.old_password.errors %}
          <div class="invalid-feedback d-block">{{ form.old_password.errors.0 }}</div>
        {% endif %}
        <div class="form-text">请输入当前登录时使用的密码</div>
      </div>

      <div class="form-group">
        <label for="{{ form.new_password1.id_for_label }}" class="form-label">新密码</label>
        <input type="password"
               class="form-control {% if form.new_password1.errors %}is-invalid{% endif %}"
               id="{{ form.new_password1.id_for_label }}"
               name="{{ form.new_password1.name }}"
               value="{{ form.new_password1.value|default_if_none:'' }}"
               required>
        {% if form.new_password1.errors %}
          <div class="invalid-feedback d-block">{{ form.new_password1.errors.0 }}</div>
        {% endif %}
        <div class="form-text">密码可以为任意字母、数字和特殊符号</div>
      </div>

      <div class="form-group">
        <label for="{{ form.new_password2.id_for_label }}" class="form-label">确认新密码</label>
        <input type="password"
               class="form-control {% if form.new_password2.errors %}is-invalid{% endif %}"
               id="{{ form.new_password2.id_for_label }}"
               name="{{ form.new_password2.name }}"
               value="{{ form.new_password2.value|default_if_none:'' }}"
               required>
        {% if form.new_password2.errors %}
          <div class="invalid-feedback d-block">{{ form.new_password2.errors.0 }}</div>
        {% endif %}
        <div class="form-text">请再次输入新密码以确保一致</div>
      </div>

      <button type="submit" class="btn btn-primary w-100 mt-2">
        <i class="bi bi-shield-check"></i> 确认修改
      </button>
    </form>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  const newPwd = document.getElementById('{{ form.new_password1.id_for_label }}');
  const confirmPwd = document.getElementById('{{ form.new_password2.id_for_label }}');
  confirmPwd.addEventListener('input', function() {
    confirmPwd.setCustomValidity(newPwd.value !== confirmPwd.value ? '两次输入的密码不一致' : '');
  });
});
</script>
{% endblock %}
