# mycourse 项目 — 当前工作状态

> 本文件由 AI 维护，用于跨对话窗口保持上下文。每完成一个阶段性节点主动更新。

---

## 项目概况

- **项目**：mycourse — 学生实验报告收集系统（Django 5.2 + SQLite + Bootstrap）
- **目标**：在保留现有功能的基础上优化升级
- **核心文档**：
  - `需求文档.md` — 完整需求规格
  - `开发计划.md` — 分 10 阶段实施计划
- **Django 项目根目录**：`g:\cursor\projects\mycourse\mycourse\mycourse\`（manage.py 所在层）
- **venv 位置**：`g:\cursor\projects\mycourse\mycourse\mycourse\venv\`
- **GitHub 仓库**：`https://github.com/szdmgy/mycourse`
- **当前管理员**：admin / admin123

---

## 当前进度

| 阶段 | 内容 | 状态 |
|------|------|------|
| 阶段 0 | 准备工作（Git、venv、启动脚本、离线资源） | ✅ 已完成 |
| 阶段 1 | 数据模型升级 | ✅ 已完成 |
| 阶段 2 | 核心 Bug 修复 + 代码清理 | ✅ 已完成 |
| 阶段 3 | 后端功能新增（多附件、复用、教师管理实验） | ⏳ 待开始 |
| 阶段 4 | 导入预览确认流程 | 待开始 |
| 阶段 5 | UI 基础框架（base.html + Bootstrap 5 + 大字体） | 待开始 |
| 阶段 6 | 学生端页面 | 待开始 |
| 阶段 7 | 教师端页面（Tab 布局） | 待开始 |
| 阶段 8 | 管理员页面 + 导入预览前端 | 待开始 |
| 阶段 9 | 收尾清理 + 回归测试 | 待开始 |

---

## 已完成阶段详情

### 阶段 0（commit `b2e6ba6`）
- Git 仓库初始化 + `.gitignore`
- 项目内 venv 创建、依赖安装（Django 5.2.4, openpyxl, waitress）
- `run_local.bat`（端口 9900）+ `show_routes.py` 路由显示
- `start_server.bat` 改用项目内 venv
- Bootstrap Icons 1.11.3 离线资源（`static/css/bootstrap-icons.min.css` + `static/fonts/`）

### 阶段 1（commit `74cf551`）
- Task 模型新增：`maxFiles`、`slot1Name`/`slot2Name`/`slot3Name`
- Homework 模型移除 `filePath`
- 新增 `HomeworkFile` 模型（homework FK, slot, filePath(255), originalName）
- 删除旧 migration、重建数据库

### 阶段 2（commit `640ac14`）
- 新建 `app01/utils.py`：file_iterator、is_teacher_or_admin、get_display_name、safe_filename
- 修复 9 个已知 Bug（见需求文档第七节）
- 所有视图适配 HomeworkFile 模型
- 所有视图添加 @login_required
- 权限统一：管理员可执行教师操作
- 所有 print() 替换为 logging
- 清理死代码

### 阶段间补丁（commit `784a7e7`）— 用户反馈：每个附件类型应独立
- Task 移除全局 `uploadFileType`，改为每个附件独立的名称+类型：
  - `slot1Name` + `slot1Type`（如：名称"实验报告"，类型".docx"）
  - `slot2Name` + `slot2Type`（如：名称"源代码"，类型".zip"）
  - `slot3Name` + `slot3Type`
- 所有"附件槽"重命名为"附件"
- views.py / upload_data.py / admin.py 同步更新
- 重建迁移和数据库

---

## 关键决策记录

1. **密码验证器全部禁用** — 用户明确要求，不修改
2. **教师不能访问 Django Admin** — 只有管理员（superuser）可以
3. **管理员权限 ≥ 教师** — 管理员能操作所有课程，复用实验时能看所有人的
4. **多附件**：1~3 个附件位，每个附件有独立的名称和文件类型限制（如：附件1"实验报告" .docx，附件2"源代码" .zip），移除了全局 uploadFileType
5. **历史实验复用**：教师只能复用自己的，管理员可看所有人的
6. **导入流程**：解析 → 预览 → 用户确认 → 才写入数据库
7. **前端资源全部离线**，禁止 CDN（部署环境无外网）
8. **字体偏大**：正文 20px，适合教学投影场景
9. **数据库可重建**：除管理员和教师账号外，其它数据可不保留
10. **两套启动脚本**：`run_local.bat`（测试端口 9900）+ `start_server.bat`（Waitress 生产端口 8001）
11. **Excel 导入格式**：按深圳大学学生成绩登记表格式（样表：`g:\教学\2025\单片机\单片机原理与应用1班.xlsx`）

---

## 当前数据模型概要

```
Task 模型字段:
  title, content, display, courseBelongTo(FK→Course), deadline,
  maxFiles(1~3), 
  slot1Name, slot1Type, slot2Name, slot2Type, slot3Name, slot3Type

Homework 模型字段:
  user(FK→UserProfile), task(FK→Task), time(auto_now)

HomeworkFile 模型字段:
  homework(FK→Homework), slot(1/2/3), filePath(255), originalName
  唯一约束: (homework, slot)
```

---

## 当前代码结构关键文件

| 文件 | 说明 |
|------|------|
| `app01/models.py` | 5 个模型：UserProfile, Course, Task, Homework, HomeworkFile |
| `app01/views.py` | 所有视图函数，已完成阶段 2 bug 修复和模型适配 |
| `app01/utils.py` | 公共工具：file_iterator, is_teacher_or_admin, get_display_name, safe_filename |
| `app01/upload_data.py` | Excel 导入逻辑（课程/学生/教师/作业） |
| `app01/admin.py` | Admin 注册（含 HomeworkFile） |
| `mycourse/urls.py` | 40+ 条路由 |
| `mycourse/settings.py` | Django 配置（DEBUG=True, SQLite, zh-hans, Asia/Shanghai） |

---

## 下一步：阶段 3 — 后端功能新增

**目标**：实现多附件上传/下载、教师添加实验改进、历史实验复用

需要做的工作（参见 `开发计划.md` 阶段 3）：
- 3.1 改造 `post_file` 视图支持多附件（含 slot 参数）
- 3.2 改造 `download_file` 视图支持多附件
- 3.3 改造教师批量下载支持多附件 ZIP 打包
- 3.4 改造 `addHomework` 视图：增加 deadline、maxFiles、slot 名称和类型
- 3.5 改造 `taskChange` 视图：支持编辑附件配置
- 3.6 新增 `copyTasks` 视图：复用历史实验
- 3.7 新增 `getHistoryTasks` API：获取可复用的历史实验列表
- 3.8 更新 `urls.py` 添加新路由
- 3.9 改造 `homeworkRecords` 和 `delayRecords` 适配新模型
- 3.10 改造 `studentCourse` 适配新模型（提交状态）

**注意**：当前 `post_file` 已适配 HomeworkFile（slot=1），阶段 3 需扩展为支持 slot 参数和每个 slot 独立的类型校验。

---

## 待办/待确认事项

- 用户已确认阶段 0~2 + 模型补丁，可直接进入阶段 3

---

## 上次更新

- 时间：2026-02-22
- 内容：用户确认阶段 2 和模型补丁（per-slot types）完成，准备进入阶段 3
- 最新 commit：`784a7e7`（已推送至 GitHub）
