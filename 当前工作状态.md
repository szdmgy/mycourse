# mycourse 项目 — 当前工作状态

> 本文件由 AI 维护，用于跨对话窗口保持上下文。每完成一个阶段性节点主动更新。

---

## 项目概况

- **项目**：mycourse — 学生实验报告收集系统（Django 5.2 + SQLite + Bootstrap）
- **目标**：在保留现有功能的基础上优化升级
- **核心文档**：
  - `需求文档.md` — 完整需求规格
  - `开发计划.md` — 分 10 阶段实施计划
- **Django 项目根目录**：`g:\cursor\projects\mycourse\mycourse\mycourse\`（manage.py 所在层）
- **venv 位置**：`g:\cursor\projects\mycourse\mycourse\mycourse\venv\`
- **GitHub 仓库**：`https://github.com/szdmgy/mycourse`
- **当前管理员**：admin / admin123

---

## 当前进度

| 阶段 | 内容 | 状态 |
|------|------|------|
| 阶段 0 | 准备工作（Git、venv、启动脚本、离线资源） | ✅ 已完成 |
| 阶段 1 | 数据模型升级 | ✅ 已完成 |
| 阶段 2 | 核心 Bug 修复 + 代码清理 | ✅ 已完成 |
| 阶段 3 | 后端功能新增（多附件、复用、教师管理实验） | ✅ 已完成 |
| 阶段 4 | 导入预览确认流程 | ✅ 已完成 |
| 阶段 5 | UI 基础框架（base.html + Bootstrap 5 + 大字体） | ✅ 已完成 |
| 阶段 6 | 学生端页面 | ✅ 已完成 |
| 阶段 7 | 教师端页面（Tab 布局） | 待开始 |
| 阶段 8 | 管理员页面 + 导入预览前端 | 待开始 |
| 阶段 9 | 收尾清理 + 回归测试 | 待开始 |

---

## 已完成阶段详情

### 阶段 0（commit `b2e6ba6`）
- Git 仓库初始化 + `.gitignore`
- 项目内 venv 创建、依赖安装（Django 5.2.4, openpyxl, waitress）
- `run_local.bat`（端口 9900）+ `show_routes.py` 路由显示
- `start_server.bat` 改用项目内 venv
- Bootstrap Icons 1.11.3 离线资源（`static/css/bootstrap-icons.min.css` + `static/fonts/`）

### 阶段 1（commit `74cf551`）
- Task 模型新增：`maxFiles`、`slot1Name`/`slot2Name`/`slot3Name`
- Homework 模型移除 `filePath`
- 新增 `HomeworkFile` 模型（homework FK, slot, filePath(255), originalName）
- 删除旧 migration、重建数据库

### 阶段 2（commit `640ac14`）
- 新建 `app01/utils.py`：file_iterator、is_teacher_or_admin、get_display_name、safe_filename
- 修复 9 个已知 Bug（见需求文档第七节）
- 所有视图适配 HomeworkFile 模型
- 所有视图添加 @login_required
- 权限统一：管理员可执行教师操作
- 所有 print() 替换为 logging
- 清理死代码

### 阶段间补丁（commit `784a7e7`）— 用户反馈：每个附件类型应独立
- Task 移除全局 `uploadFileType`，改为每个附件独立的名称+类型：
  - `slot1Name` + `slot1Type`（如：名称"实验报告"，类型".docx"）
  - `slot2Name` + `slot2Type`（如：名称"源代码"，类型".zip"）
  - `slot3Name` + `slot3Type`
- 所有"附件槽"重命名为"附件"
- views.py / upload_data.py / admin.py 同步更新
- 重建迁移和数据库

---

## 关键决策记录

1. **密码验证器全部禁用** — 用户明确要求，不修改
2. **教师不能访问 Django Admin** — 只有管理员（superuser）可以
3. **管理员权限 ≥ 教师** — 管理员能操作所有课程，复用实验时能看所有人的
4. **多附件**：1~3 个附件位，每个附件有独立的名称和文件类型限制（如：附件1"实验报告" .docx，附件2"源代码" .zip），移除了全局 uploadFileType
5. **历史实验复用**：教师只能复用自己的，管理员可看所有人的
6. **导入流程**：解析 → 预览 → 用户确认 → 才写入数据库
7. **前端资源全部离线**，禁止 CDN（部署环境无外网）
8. **字体偏大**：正文 20px，适合教学投影场景
9. **数据库可重建**：除管理员和教师账号外，其它数据可不保留
10. **两套启动脚本**：`run_local.bat`（测试端口 9900）+ `start_server.bat`（Waitress 生产端口 8001）
11. **Excel 导入格式**：按深圳大学学生成绩登记表格式（样表：`g:\教学\2025\单片机\单片机原理与应用1班.xlsx`）

---

## 当前数据模型概要

```
Task 模型字段:
  title, content, display, courseBelongTo(FK→Course), deadline,
  maxFiles(1~3), 
  slot1Name, slot1Type, slot2Name, slot2Type, slot3Name, slot3Type

Homework 模型字段:
  user(FK→UserProfile), task(FK→Task), time(auto_now)

HomeworkFile 模型字段:
  homework(FK→Homework), slot(1/2/3), filePath(255), originalName
  唯一约束: (homework, slot)
```

---

## 当前代码结构关键文件

| 文件 | 说明 |
|------|------|
| `app01/models.py` | 5 个模型：UserProfile, Course, Task, Homework, HomeworkFile |
| `app01/views.py` | 所有视图函数（阶段 3 多附件+复用+下载 + 阶段 4 导入预览确认） |
| `app01/utils.py` | 公共工具：file_iterator, is_teacher_or_admin, get_display_name, safe_filename |
| `app01/upload_data.py` | 三层架构：parse（纯解析）→ preview（读 DB 标注）→ write（写入 DB），保留旧版兼容 |
| `app01/admin.py` | Admin 注册（含 HomeworkFile） |
| `mycourse/urls.py` | 50+ 条路由（含 copyTasks, getHistoryTasks, download-homework-file, preview-import, confirm-import） |
| `mycourse/settings.py` | Django 配置（DEBUG=True, SQLite, zh-hans, Asia/Shanghai） |
| `templates/base.html` | 公共模板：Bootstrap 5 导航栏 + block 机制，所有新页面继承此模板 |
| `static/css/global.css` | 全局样式：大字体（body 20px）+ 导航栏主题 + 状态 badge 类 |
| `templates/import_preview.html` | 导入预览页（独立样式，尚未继承 base.html） |

---

### 阶段 3（本次完成）
- 3.1 `post_file` 支持 slot 参数 + 每 slot 独立文件类型校验
- 3.2 `download_file` 保留向后兼容 + 新增 `download_homework_file`（按 HomeworkFile ID 下载）
- 3.3 教师批量下载适配多附件 ZIP 打包，目录结构：`学号_姓名/slotN_槽位名.ext`
- 3.4 `addHomework` 支持 deadline、maxFiles、slot1~3 Name/Type
- 3.5 `taskChange` 的 TaskEditForm 扩展为含附件配置（maxFiles + 6 个 slot 字段）
- 3.6 新增 `copyTasks` 视图：从历史课程复制实验，标题冲突自动追加"(副本)"
- 3.7 新增 `getHistoryTasks` API：教师看自己课程、管理员看所有课程
- 3.8 `urls.py` 新增 3 条路由：copyTasks、getHistoryTasks、download-homework-file
- 3.9 `homeworkRecords` 返回 dict（含 slot_info、submitted_count）；`delayRecords` 增加部分提交检测
- 3.10 `studentCourse` 五态提交状态（submitted/partial/pending/delay_submitted/overdue）；`taskSubmit` 输出 slots 列表；`studentGetTaskByCoursename` 适配

---

### 阶段 4（本次完成）
- 4.1 `upload_data.py` 拆分为三层：parse（纯解析）→ preview（读 DB 标注状态）→ write（写入 DB）
- 4.2 新增 `preview_import` 视图：解析 Excel → 存 session → 渲染预览页
- 4.3 新增 `confirm_import` 视图：从 session 取数据 → 写入 DB
- 4.4 新增 `import_preview.html` 模板：课程/教师/学生三段表格 + 状态标注 + 确认/取消按钮
- 4.5 `import.html` 增加"预览导入"入口（推荐方式）
- 4.6 `urls.py` 新增 2 条路由：preview-import、confirm-import

---

### 阶段 5（本次完成）
- 5.1 新建 `base.html`：Bootstrap 5 导航栏（角色自适应菜单）+ 全局样式 + block 机制
- 5.2 新建 `static/css/global.css`：body 20px / table 18px / h1 32px / h2 28px / h3 24px / badge 16px + 导航栏渐变主题 + 状态 badge 类
- 5.3 `login.html` 保持独立，字体同步放大（body 20px, title 28px, input 18px）
- 5.4 `change_password.html` 改为继承 base.html，Bootstrap 5 卡片布局
- 5.5 `profile.html` 改为继承 base.html，表单控件加 form-control 类
- 5.6 UserProfileEditForm widgets 添加 Bootstrap CSS class
- Bootstrap 3 文件暂保留（其他页面仍引用），Phase 9 统一清理

---

### 阶段 6（本次完成）
- 6.1 `studentCourseList.html` 继承 base.html，课程卡片布局（含实验数量 badge）
- 6.2 `studentTaskList.html` 继承 base.html，五态状态 badge（submitted/partial/pending/delay/overdue）
- 6.3 `studentSubmit.html` 完全重构：多 slot 上传区域（每 slot 独立上传按钮 + 已上传文件下载链接）
- 6.4 上传 JS 改为 `uploadSlot(taskId, slot)` 函数，传 slot 参数到后端

---

## 下一步：阶段 7 — 教师端页面（工作量最大的阶段）

**目标**：教师端课程详情 Tab 布局 + 历史实验复用前端

需要做的工作（参见 `开发计划.md` 阶段 7）：
- 7.1 `teacherCourseList.html` 继承 base.html
- 7.2 新建 `teacherCourseDetail.html` Tab 布局（替代原 teacherCourseChange + teacherTasks）
- 7.3 Tab 1 — 作业管理（列表+添加+编辑+删除+复用）
- 7.4 Tab 2 — 提交统计（已交/未交+批量下载）
- 7.5 Tab 3 — 学生管理（名单+添加+移除+重置密码）
- 7.6 Tab 4 — 课程设置（信息修改+异常记录+删除）
- 7.7 更新 `teacherTasks.js` 适配新页面
- 7.8 历史实验复用 — 前端弹窗和交互（调用 getHistoryTasks + copyTasks API）
- 7.9 `homeworkRecords.html` 继承 base.html（适配 dict 格式返回数据）
- 7.10 `delayRecords.html` 继承 base.html
- 7.11 `taskChange.html` 继承 base.html + 支持附件槽配置编辑

**注意事项**：
- `homeworkRecords` 视图在阶段 3 已改为返回 dict（含 slot_info），旧模板用 list index 取值会报错，必须适配
- `taskChange` 视图在阶段 3 已扩展 TaskEditForm（9 个字段），上下文增加了 `form`
- 批量下载 JS 需要适配多 slot（当前 teacherTasks.js 是旧版）
- 后端 `addHomework` 已支持 deadline/maxFiles/slot 参数，前端表单需匹配
- 后端 `getHistoryTasks` 和 `copyTasks` API 已就绪，前端需要 AJAX 调用

---

## 待办/待确认事项

- 阶段 0~6 全部完成并推送，尚未进行完整的端到端测试
- `import_preview.html` 使用独立样式，阶段 8 应改为继承 base.html
- Bootstrap 3 文件仍保留在 static/ 目录（部分旧模板如 teacherTasks.html 等仍引用），阶段 9 统一清理
- 用户已明确授权直接实施（"从阶段 3 开始实施"），后续阶段可继续执行

---

## 上次更新

- 时间：2026-02-22
- 内容：完成阶段 6 学生端页面，阶段 0~6 全部完成并推送至 GitHub
- 最新 commit：`3aa487d`（Phase 6，已推送）
- Git 状态：working tree clean，up to date with origin/master
